<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page_metadata.title }} - Universal Automation Wiki</title>
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="stylesheet" href="/assets/css/components.css">
    <link rel="stylesheet" href="/assets/css/responsive.css">
    <link rel="stylesheet" href="/assets/css/article.css">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Header placeholder to be filled by components.js -->
    <div id="header-placeholder"></div>

    <main>
        <section class="hero">
            <div class="container">
                <h1>{{ page_metadata.title }}</h1>
                <p class="hero-subtitle">{{ page_metadata.subtitle }}</p>
            </div>
        </section>

        <section class="wiki-article">
            <div class="container article-layout-container"> {# This div is now the flex container #}
                
                <div class="wiki-content-main"> {# Wrapper for the main content column #}
                    <div class="breadcrumbs">
                        {% if breadcrumbs %}
                            {% for crumb in breadcrumbs[:-1] %}
                                <span><a href="{{ crumb.url }}">{{ crumb.name }}</a></span>
                            {% endfor %}
                            <span>{{ breadcrumbs[-1].name }}</span> {# Last item is current page, not linked #}
                        {% endif %}
                    </div>
                    
                    <div class="status-indicator">
                        <div class="dot"></div>
                        <span>{{ page_metadata.automation_status }}</span>
                    </div>
                    
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: {{ page_metadata.progress_percentage }}%;"></div>
                    </div>
                    
                    <div class="article-summary">
                        {{ page_metadata.explanatory_text|safe }}
                    </div>
                    
                    {# Persona selector is now in the sidebar #}
                    
                    <div class="article-content-area">
                        {% if all_content_sections %}
                            {% for section in all_content_sections %}
                            {# Make first section expanded by default, others collapsed #}
                            {% set is_first_section = loop.first %}
                            <div class="content-section {% if not is_first_section %}collapsed{% endif %}"
                                 data-section-id="{{ section.id }}"
                                 data-relevant-personas='{{ section.relevant_personas_json }}'>
                                <h3 class="section-header" id="section-header-{{ section.id }}"> {# Changed h3 to have class for styling button #}
                                    <button class="section-toggle-button"
                                            aria-expanded="{{ 'true' if is_first_section else 'false' }}"
                                            aria-controls="section-body-{{ section.id }}">
                                        <span class="section-title-text">{{ section.title_text | safe if section.title_text else section.title_html | safe }}</span>
                                        <span class="toggle-indicator">{% if is_first_section %}â–¼{% else %}â–º{% endif %}</span>
                                    </button>
                                    {# Metrics icon moved next to the toggle button, within the h3 #}
                                    <button class="metrics-icon"
                                            aria-label="View metrics for {{ section.title_text | default('this section') }}"
                                            data-section-id="{{ section.id }}"
                                            data-metrics='{{ section.metrics_data_json }}'>
                                        ðŸ“Š
                                    </button>
                                </h3>
                                <div class="section-body"
                                     id="section-body-{{ section.id }}"
                                     {% if not is_first_section %}hidden{% endif %}>
                                    {{ section.content_html | safe if section.content_html else section.content_html_output | safe }} {# Use content_html or fallback #}
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p><em>No content sections available for display. Please check the data source.</em></p>
                        {% endif %}
                    </div>
                    
                    <div class="contributors-section">
                        <h3>Contributors</h3>
                        <p>This workflow was developed using Iterative AI analysis of {{ page_metadata.title | lower }} processes with input from professional engineers and automation experts.</p>
                        <p><em>Last updated: {{ page_metadata.last_updated | default("Current Date") }}</em></p>
                        <a href="#" class="button secondary" id="suggest-improvements">Suggest Improvements</a>
                        
                        <div id="feedback-form-container" class="feedback-form-container">
                            <h4>Suggest Improvements</h4>
                            <p>We value your input on how to improve this {{ page_metadata.title | lower }} workflow. Please provide your suggestions below.</p>
                            
                            <form id="feedback-form" class="feedback-form">
                                <div class="feedback-form-field">
                                    <label for="feedback-name">Name (optional)</label>
                                    <input type="text" id="feedback-name" name="name" placeholder="Your name">
                                </div>
                                
                                <div class="feedback-form-field">
                                    <label for="feedback-email">Email (optional)</label>
                                    <input type="email" id="feedback-email" name="email" placeholder="your@email.com">
                                </div>
                                
                                <div class="feedback-form-field">
                                    <label for="feedback-subject">Subject</label>
                                    <input type="text" id="feedback-subject" name="subject" placeholder="Brief description of your suggestion" required>
                                </div>
                                
                                <div class="feedback-form-field">
                                    <label for="feedback-body">Feedback Details</label>
                                    <textarea id="feedback-body" name="message" placeholder="Please describe your suggestion in detail..." required></textarea>
                                </div>
                                
                                <div class="feedback-actions">
                                    <button type="button" id="cancel-feedback" class="button secondary">Cancel</button>
                                    <button type="submit" id="send-feedback" class="button primary">Send Feedback</button>
                                </div>
                            </form>
                            
                            <div id="feedback-message" class="feedback-message"></div>
                        </div>
                    </div>
                </div> <!-- This now correctly closes wiki-content-main -->

                <aside class="wiki-sidebar">
                    <div id="persona-selector-widget" class="sticky-widget">
                        <label for="persona-selector">Persona:</label>
                        <select id="persona-selector" name="persona">
                            {% for persona_key, persona_name in core_personas.items() %}
                            <option value="{{ persona_key }}">{{ persona_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </aside>

            </div> <!-- This now correctly closes container article-layout-container -->
        </section>
    </main>

    <!-- Footer placeholder to be filled by components.js -->
    <div id="footer-placeholder"></div>
    
    <script src="/assets/js/components.js"></script>
    <script src="/assets/js/main.js"></script>
    {# <script src="/assets/js/tabbed-content.js"></script> #} <!-- Tabbed content JS is no longer needed -->
    <script src="/assets/js/feedback.js"></script>
</body>
</html>
<!-- Metrics Modal Structure -->
    <div id="metrics-modal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="metrics-modal-title">
        <div class="modal-overlay" tabindex="-1" data-micromodal-close></div>
        <div class="modal-container" role="document">
            <header class="modal-header">
                <h2 id="metrics-modal-title" class="modal-title">Section Metrics</h2>
                <button class="modal-close" aria-label="Close modal" data-micromodal-close>&#x2715;</button>
            </header>
            <main class="modal-content" id="metrics-modal-content">
                <p>Loading metrics...</p>
            </main>
            <footer class="modal-footer">
                <button class="button" data-micromodal-close aria-label="Close this dialog window">Close</button>
            </footer>
        </div>
    </div>