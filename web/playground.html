<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Simulation Playground - Universal Automation Wiki</title>
        <meta
            name="description"
            content="Interactive simulation playground for testing and visualizing automation workflows"
        />

        <!-- SEO Meta Tags -->
        <meta name="keywords" content="simulation, automation, workflow, process optimization, playground, interactive, visualization" />
        <meta name="author" content="Universal Automation Wiki" />
        <meta name="robots" content="index, follow" />
        <link rel="canonical" href="https://jamiem0.github.io/uaw/playground.html" />

        <!-- Open Graph Meta Tags for Social Sharing -->
        <meta property="og:type" content="website" />
        <meta property="og:title" content="Simulation Playground - Universal Automation Wiki" />
        <meta property="og:description" content="Interactive simulation playground for testing and visualizing automation workflows. Create, edit, and simulate complex processes with real-time validation." />
        <meta property="og:url" content="https://jamiem0.github.io/uaw/playground.html" />
        <meta property="og:site_name" content="Universal Automation Wiki" />
        <meta property="og:locale" content="en_US" />

        <!-- Twitter Card Meta Tags -->
        <meta name="twitter:card" content="summary_large_image" />
        <meta name="twitter:title" content="Simulation Playground - Universal Automation Wiki" />
        <meta name="twitter:description" content="Interactive simulation playground for testing and visualizing automation workflows" />

        <!-- Theme and Browser Chrome -->
        <meta name="theme-color" content="#007bff" />
        <meta name="color-scheme" content="light dark" />

        <!-- Preload critical CSS for better performance -->
        <link rel="preload" href="/assets/css/main.css" as="style" />
        <link rel="preload" href="/assets/css/playground.css" as="style" />

        <link rel="stylesheet" href="/assets/css/main.css" />
        <link rel="stylesheet" href="/assets/css/components.css" />
        <link rel="stylesheet" href="/assets/css/simulation.css" />
        <link rel="stylesheet" href="/assets/css/space-editor.css" />
        <link rel="stylesheet" href="/assets/css/playground.css" />
        <link rel="stylesheet" href="/assets/css/drag-overlay.css" />
        <link rel="stylesheet" href="/assets/css/emoji-picker.css" />
        <link rel="stylesheet" href="/assets/css/smart-actions.css" />
        <link rel="stylesheet" href="/assets/css/multi-period.css" />

        <link rel="icon" href="/favicon.ico" type="image/x-icon" />

        <!-- Iframe-specific styles -->
        <style>
            /* Hide sections when loaded in iframe */
            .iframe-embedded .json-editor-panel,
            .iframe-embedded .tab-bar {
                display: none !important;
            }

            /* Show only specific header elements in iframe */
            .iframe-embedded .playground-header .logo,
            .iframe-embedded .playground-header h1,
            .iframe-embedded .playground-header .file-operations-group > *:not(#simulation-library-btn):not(.dropdown),
            .iframe-embedded .playground-header .view-options-group > *:not(#dark-mode-toggle):not(#undo-btn),
            .iframe-embedded .playground-header .advanced-tools-group {
                display: none !important;
            }

            /* Keep visible: Simulation Library, Edit Operations, Dark Mode, Undo, Player Controls */
            .iframe-embedded .playground-header .dropdown:has(#simulation-library-btn),
            .iframe-embedded .playground-header .edit-operations-group,
            .iframe-embedded .playground-header #dark-mode-toggle,
            .iframe-embedded .playground-header #undo-btn,
            .iframe-embedded .playground-header .playback-controls-group {
                display: flex !important;
            }

            /* Simplify header layout in iframe */
            .iframe-embedded .playground-header .header-actions {
                gap: 1rem;
            }

            /* Adjust layout when in iframe to account for header and validation panel */
            .iframe-embedded .playground-top {
                height: 50vh; /* Take up half the viewport */
            }

            .iframe-embedded .playground-bottom {
                height: calc(50vh - 60px); /* Other half minus header height */
            }

            .iframe-embedded .simulation-panel {
                width: 100%;
                border-left: none;
            }

            .iframe-embedded .tab-content-wrapper {
                border-top: none;
            }

            /* Ensure validation panel is visible and properly sized */
            .iframe-embedded .validation-panel {
                display: flex !important;
                flex-direction: column;
                height: 100%;
            }

            .iframe-embedded .validation-content {
                flex: 1;
                overflow-y: auto;
            }
        </style>
        <!-- DNS prefetch and preconnect for external resources -->
        <link rel="dns-prefetch" href="https://fonts.googleapis.com" />
        <link rel="dns-prefetch" href="https://fonts.gstatic.com" />
        <link rel="dns-prefetch" href="https://unpkg.com" />
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link rel="preconnect" href="https://unpkg.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
            rel="stylesheet"
        />

        <script src="/assets/js/simulation-validator.js" defer></script>
        <script src="/assets/js/space-editor.js" defer></script>
        <script src="/assets/js/emoji-picker.js" defer></script>

        <script src="/assets/js/tutorial.js" defer></script>
        <script src="/assets/js/tutorial-validator.js" defer></script>
        <script src="/assets/js/simulation-player.js" defer></script>

        <!-- Monaco Editor for JSON syntax highlighting -->
        <script src="https://unpkg.com/monaco-editor@0.44.0/min/vs/loader.js"></script>
        
        <!-- JSZip - Load after Monaco to avoid AMD conflicts -->
        <script>
            // Load JSZip after Monaco Editor is ready to avoid AMD conflicts
            let jszipLoadAttempted = false;
            
            function loadJSZip() {
                if (jszipLoadAttempted) return;
                jszipLoadAttempted = true;
                
                // Temporarily disable AMD to force global registration
                const originalDefine = window.define;
                window.define = undefined;
                
                // Try local first
                const localScript = document.createElement('script');
                localScript.src = '/assets/js/jszip.min.js';
                localScript.onload = () => {
                    // Restore AMD after a brief delay
                    setTimeout(() => {
                        window.define = originalDefine;
                        if (typeof window.JSZip !== 'undefined') {
                            window.JSZipReady = true;
                        } else {
                            loadJSZipFromCDN();
                        }
                    }, 100);
                };
                localScript.onerror = () => {
                    window.define = originalDefine;
                    loadJSZipFromCDN();
                };
                document.head.appendChild(localScript);
            }
            
            function loadJSZipFromCDN() {
                // Temporarily disable AMD to force global registration
                const originalDefine = window.define;
                window.define = undefined;
                
                const cdnScript = document.createElement('script');
                cdnScript.src = 'https://unpkg.com/jszip@3.10.1/dist/jszip.min.js';
                cdnScript.onload = () => {
                    // Restore AMD after a brief delay
                    setTimeout(() => {
                        window.define = originalDefine;
                        if (typeof window.JSZip !== 'undefined') {
                            window.JSZipReady = true;
                        } else {
                            window.JSZipFailed = true;
                        }
                    }, 100);
                };
                cdnScript.onerror = () => {
                    window.define = originalDefine;
                    window.JSZipFailed = true;
                };
                document.head.appendChild(cdnScript);
            }
            
            // Load JSZip after DOM is ready and Monaco has had time to initialize
            document.addEventListener('DOMContentLoaded', () => {
                setTimeout(loadJSZip, 1000); // Wait 1 second for Monaco to settle
            });
        </script>

        <!-- Iframe detection script -->
        <script>
            // Detect if we're running in an iframe and apply appropriate styling
            (function() {
                function detectIframe() {
                    // Method 1: Check URL parameter (most reliable for Safari)
                    const urlParams = new URLSearchParams(window.location.search);
                    if (urlParams.get('embedded') === 'true') {
                        return true;
                    }

                    // Method 2: Standard check
                    try {
                        if (window.self !== window.top) {
                            return true;
                        }
                    } catch (e) {
                        return true;
                    }

                    // Method 3: Check if we can access parent (Safari-specific)
                    try {
                        if (window.parent && window.parent !== window) {
                            // Try to access parent's location to see if we're in an iframe
                            const parentLoc = window.parent.location.href;
                            return true;
                        }
                    } catch (e) {
                        // Cross-origin iframe in Safari - this catch block indicates we're in an iframe
                        return true;
                    }

                    // Method 4: Check frameElement
                    try {
                        if (window.frameElement !== null) {
                            return true;
                        }
                    } catch (e) {
                        return true;
                    }

                    // Method 5: Safari-specific viewport check
                    // In Safari iframes, viewport dimensions might be constrained differently
                    if (window.innerHeight < 600 && window.innerWidth < 800) {
                        // Check if we have a referrer that's different from our current page
                        if (document.referrer && document.referrer !== '' && document.referrer !== window.location.href) {
                            return true;
                        }
                    }

                    return false;
                }

                // Apply iframe-specific class immediately to prevent layout shift
                if (detectIframe()) {
                    document.documentElement.classList.add('iframe-embedded');
                    // Also hide the welcome overlay when in iframe
                    document.addEventListener('DOMContentLoaded', function() {
                        const welcomeOverlay = document.getElementById('welcome-overlay');
                        if (welcomeOverlay) {
                            welcomeOverlay.style.display = 'none';
                        }
                    });
                }

                // Add domain data attribute for CSS targeting
                document.addEventListener('DOMContentLoaded', function() {
                    document.body.setAttribute('data-domain', window.location.hostname);
                });
            })();
        </script>

    </head>
    <body>
        <div id="welcome-overlay" class="dialog-overlay" style="display: flex;" role="dialog" aria-modal="true" aria-labelledby="welcome-title">
            <div class="dialog">
                <h2 id="welcome-title" class="special-subtitle">Welcome to the Simulation Playground!</h2>
                <p>This playground is an interactive tool for testing and visualising automation workflows.</p>
                <p>You can create, edit, and simulate complex processes to understand how they work and identify potential improvements.</p>
                <p>The Universal Automation Wiki (UAW) project, including this playground, is open source. We welcome contributions and feedback from the community. You can find the project on <a href="https://github.com/JamieM0/uaw" target="_blank">GitHub</a>.</p>
                <p>Please save your work regularly. The simulation playground is in early development, and we recommend keeping backups of your work. Remember some work may be stored in separate files ('metrics-catalog-custom.json' and 'simulation-validator-custom.js').</p>
                <p><strong>Tip:</strong> You can use emojis in any text field!
                <ul>
                    <li>Press <strong>Ctrl + .</strong> or <strong>Cmd + .</strong> to open the emoji selector.</li>
                    <li>In the JSON editor, right-click and choose 'Insert Emoji'.</li>
                </ul>
                </p>
                <p><strong>Tip:</strong> In space editors, you can quickly <strong>tap space</strong> to zoom to fit, or you can <strong>hold space</strong> to pan around.</p>
                <div class="dialog-buttons" style="margin-top: 1rem; justify-content: center; flex-direction: column;">
                    <div style="margin-bottom: 1rem;">
                        <label>
                            <input type="checkbox" id="dont-show-again">
                            Don't show again
                        </label>
                    </div>
                    <button type="button" class="btn-primary" id="welcome-continue-btn" style="display: none;">Continue</button>
                    <div style="display: flex; justify-content: center; gap: 1rem;">
                        <button type="button" class="btn-secondary" id="skip-tutorial-btn">Skip Tutorial</button>
                        <button type="button" class="btn-primary" id="start-tutorial-welcome-btn">Start Tutorial</button>
                    </div>
                </div>
            </div>
        </div>
        <header class="playground-header" role="banner">
            <div class="container header-container">
                <div class="logo">
                    <a href="/" aria-label="Return to Universal Automation Wiki homepage">
                        <img
                            src="/assets/images/logo-abbrev-inline.svg"
                            alt="Universal Automation Wiki Logo"
                        />
                    </a>
                </div>
                <h1 class="special-title">Playground</h1>
                <nav class="header-actions" role="navigation" aria-label="Playground controls">
                    <!-- File Operations Group -->
                    <div class="file-operations-group">
                        <div class="dropdown">
                            <button id="simulation-library-btn" class="dropdown-toggle" aria-haspopup="true" aria-expanded="false">Simulation Library ‚ñº</button>
                            <div id="simulation-library-dropdown" class="dropdown-content" role="menu">
                                <!-- Simulation options will be populated here -->
                            </div>
                        </div>
                        <button id="load-simulation-btn" class="action-btn" title="Load simulation from save code" aria-label="Load simulation">Load</button>
                        <button id="save-simulation-btn" class="action-btn" title="Save simulation and get save code" aria-label="Save simulation">Save</button>
                    </div>

                    <!-- Edit Operations Group -->
                    <div class="edit-operations-group">
                        <button class="action-btn" id="add-object-btn">+ Object</button>
                        <button class="action-btn" id="add-task-btn">+ Task</button>
                    </div>

                    <!-- View Options Group -->
                    <div class="view-options-group">
                        <div class="dropdown">
                            <button class="action-btn" aria-haspopup="true" aria-expanded="false" aria-label="Tools menu">Tools ‚ñº</button>
                            <div class="dropdown-content" role="menu">
                                <a href="#" id="format-json-btn" role="menuitem">Format JSON</a>
                                <a href="#" id="clear-editor-btn" role="menuitem">Clear</a>
                                <a href="#" id="undo-btn" class="undo-button" disabled title="Undo last change (Ctrl+Z)" role="menuitem">‚Ü∂ Undo</a>
                                <a href="#" id="reset-panel-sizes-btn" role="menuitem">Reset Panel Sizes</a>
                                <a href="#" id="render-simulation-btn" class="hidden" role="menuitem">Render Simulation</a>
                                <a href="#" id="auto-render-toggle" class="hidden" role="menuitem">Toggle Auto-render</a>
                                <a href="#" id="toggle-auto-validate-btn" role="menuitem">Disable Auto-Validate</a>
                            </div>
                        </div>
                        <button id="dark-mode-toggle" class="mode-toggle-btn" title="Toggle Dark Mode">
                            ‚òæ Dark
                        </button>
                        <button id="metrics-mode-toggle" class="mode-toggle-btn" title="Toggle Metrics Editor Mode">
                            Metrics Editor
                        </button>
                        <button id="add-metric-btn" class="btn btn-secondary" style="display: none;" title="Add Custom Metric">
                            + Add Metric
                        </button>
                        <button
                            id="fullscreen-btn"
                            class="fullscreen-btn primary hidden"
                            title="Toggle fullscreen simulation view"
                        >
                            ‚õ∂
                        </button>
                    </div>

                    <!-- Playback Controls Group -->
                    <div class="playback-controls-group">
                        <button id="player-play-pause-btn" title="Play/Pause Simulation" aria-label="Play or pause simulation">‚ñ∂Ô∏è</button>
                        <div class="player-time-display" role="timer" aria-live="off">
                            <span id="player-current-time">00:00</span>
                        </div>
                        <div class="player-speed-control">
                            <label for="player-speed-select">Speed:</label>
                            <select id="player-speed-select" aria-label="Playback speed">
                                <option value="0.5">0.5x</option>
                                <option value="1" selected>1x</option>
                                <option value="2">2x</option>
                                <option value="5">5x</option>
                                <option value="10">10x</option>
                            </select>
                        </div>
                    </div>

                    <!-- Advanced Tools Group -->
                    <div class="advanced-tools-group">
                        <div class="dropdown" id="smart-actions-dropdown">
                            <button class="action-btn" id="smart-actions-menu-btn" aria-haspopup="true" aria-expanded="false">Smart Actions ‚ñº</button>
                            <div class="dropdown-content" role="menu">
                                <a href="#" id="smart-action-chat" role="menuitem">Chat</a>
                                <a href="#" id="smart-action-setup" role="menuitem">Setup</a>
                            </div>
                        </div>
                        <div class="dropdown">
                            <button class="action-btn" aria-haspopup="true" aria-expanded="false" aria-label="Help menu">Help ‚ñº</button>
                            <div class="dropdown-content" role="menu">
                                <a href="#" id="start-tutorial-btn" role="menuitem">Start Tutorial</a>
                                <a href="#" id="start-llm-btn" role="menuitem">Experimental LLM</a>
                            </div>
                        </div>
                        <button id="submit-btn" class="action-btn" title="Submit simulation to page" style="display: none;">Submit</button>
                        <button id="feedback-btn" class="action-btn" title="Send feedback about the playground">Feedback</button>
                    </div>
                </nav>
            </div>
        </header>

        <main class="playground-main" role="main">
            <div id="tutorial-panel" class="tutorial-panel" role="complementary" aria-labelledby="tutorial-title">
                <div class="tutorial-header">
                    <h3 id="tutorial-title">Tutorial</h3>
                    <button id="tutorial-exit-btn" class="tutorial-exit-btn" title="Exit Tutorial" aria-label="Exit tutorial">√ó</button>
                </div>
                <div class="tutorial-content">
                    <div id="tutorial-instructions"></div>
                    <div id="tutorial-status" style="display: none; margin-top: 1rem;"></div>
                </div>
                <div class="tutorial-footer">
                    <button id="tutorial-prev-btn">Back</button>
                    <button id="tutorial-next-btn" disabled>Next</button>
                </div>
            </div>
            
            <div style="display: flex; flex-direction: column; flex: 1; min-width: 0;">
                <div class="playground-top">
                    <div class="playground-left">
                        <!-- Standard Mode: Two panels side by side -->
                        <div class="standard-mode-layout">
                            <div class="json-editor-panel">
                                <div class="panel-header"></div>
                                <div class="panel-content">
                                    <div id="json-editor"></div>
                                </div>
                                <div class="resize-handle-vertical"></div>
                            </div>

                            <div class="simulation-panel">
                                <div class="tab-bar" role="tablist" aria-label="Simulation view tabs">
                                    <button class="tab-btn active" data-tab="timeline" role="tab" aria-selected="true" aria-controls="simulation-tab">Simulation Render</button>
                                    <button class="tab-btn" data-tab="space-editor" role="tab" aria-selected="false" aria-controls="space-editor-tab">Space Editor</button>
                                    <button class="tab-btn" data-tab="digital-space" role="tab" aria-selected="false" aria-controls="digital-space-tab">Digital Locations</button>
                                    <button class="tab-btn" data-tab="display-editor" role="tab" aria-selected="false" aria-controls="display-editor-tab">Display Editor</button>
                                </div>

                                <div class="tab-content-wrapper">
                                    <div id="simulation-tab" class="tab-content active" role="tabpanel" aria-labelledby="simulation-render-tab">
                                        <div id="simulation-content" class="simulation-content">
                                            <!-- Existing simulation content -->
                                        </div>
                                        <div id="simulation-loading" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(255,255,255,0.9); padding: 1rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);" role="status" aria-live="polite">
                                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                <div style="width: 20px; height: 20px; border: 2px solid #ddd; border-top: 2px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                                                Rendering simulation...
                                            </div>
                                        </div>
                                    </div>
                                    <div id="space-editor-tab" class="tab-content" role="tabpanel" aria-labelledby="space-editor-tab-btn">
                                        <div class="space-editor-container">
                                            <div class="space-canvas" id="space-canvas">
                                                <div class="zoom-controls">
                                                    <button type="button" class="zoom-btn zoom-in-btn" id="zoom-in-btn" title="Zoom In">
                                                        <span class="zoom-icon">+</span>
                                                    </button>
                                                    <button type="button" class="zoom-btn zoom-out-btn" id="zoom-out-btn" title="Zoom Out">
                                                        <span class="zoom-icon">‚àí</span>
                                                    </button>
                                                    <button type="button" class="zoom-btn zoom-fit-btn" id="zoom-fit-btn" title="Zoom to Fit">
                                                        <span class="zoom-icon">‚õ∂</span>
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="properties-panel-container">
                                                <div class="properties-panel-header">
                                                    <div class="properties-panel-header-top">
                                                        <h4>Properties</h4>
                                                        <button id="add-location-btn" class="btn btn-primary">+ Add</button>
                                                    </div>
                                                    <div class="layer-controls">
                                                        <label for="layer-filter">Layer:</label>
                                                        <select id="layer-filter">
                                                            <option value="all">All Layers</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div id="properties-panel-content">
                                                    <p class="placeholder">Select a location, or click '+ Add' to draw a new one.</p>
                                                </div>
                                                <div class="options-panel-container">
                                                    <div class="options-panel-header">
                                                        <h4>Options</h4>
                                                    </div>
                                                    <div id="options-panel-content">
                                                        <div class="option-field">
                                                            <label>
                                                                <input type="checkbox" id="snap-x-enabled" checked> Enable Vertical Snapping
                                                            </label>
                                                        </div>
                                                        <div class="option-field">
                                                            <label>
                                                                <input type="checkbox" id="snap-z-enabled" checked> Enable Horizontal Snapping
                                                            </label>
                                                        </div>
                                                        <div class="option-field">
                                                            <label for="snap-tolerance">Snap Tolerance:</label>
                                                            <input type="number" id="snap-tolerance" value="10" min="1" max="50" step="1">
                                                            <span>px</span>
                                                        </div>
                                                        <div class="option-field">
                                                            <label for="space-scroll-sensitivity">Scroll Sensitivity:</label>
                                                            <input type="range" id="space-scroll-sensitivity" min="0.2" max="5" step="0.1" value="1">
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="digital-space-tab" class="tab-content" role="tabpanel" aria-labelledby="digital-space-tab-btn">
                                        <div class="space-editor-container">
                                            <div class="space-canvas" id="digital-space-canvas">
                                                <div class="zoom-controls">
                                                    <button type="button" class="zoom-btn zoom-in-btn" id="digital-zoom-in-btn" title="Zoom In">
                                                        <span class="zoom-icon">+</span>
                                                    </button>
                                                    <button type="button" class="zoom-btn zoom-out-btn" id="digital-zoom-out-btn" title="Zoom Out">
                                                        <span class="zoom-icon">‚àí</span>
                                                    </button>
                                                    <button type="button" class="zoom-btn zoom-fit-btn" id="digital-zoom-fit-btn" title="Zoom to Fit">
                                                        <span class="zoom-icon">‚õ∂</span>
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="properties-panel-container">
                                                <div class="properties-panel-header">
                                                    <div class="properties-panel-header-top">
                                                        <h4>Digital Locations</h4>
                                                        <button id="add-digital-location-btn" class="btn btn-primary btn-compact">+ Add Location</button>
                                                    </div>
                                                    <div class="layer-controls">
                                                        <label for="digital-layer-filter">Type:</label>
                                                        <select id="digital-layer-filter">
                                                            <option value="all">All Objects</option>
                                                            <option value="storage">Storage</option>
                                                            <option value="database">Database</option>
                                                            <option value="cache">Cache</option>
                                                            <option value="network">Network</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div id="digital-properties-panel-content">
                                                    <p style="color: var(--text-lighter); font-style: italic; font-size: 13px; text-align: center; padding: 16px;">Select a digital location, or click '+ Add Location' to create a new storage area.</p>
                                                </div>
                                                <div class="options-panel-container">
                                                    <div class="options-panel-header">
                                                        <h4>Tools & Objects</h4>
                                                    </div>
                                                    <div id="digital-options-panel-content">
                                                        <div class="option-field">
                                                            <button type="button" class="btn btn-secondary full-width" id="add-digital-object-btn">+ Add Digital Object</button>
                                                        </div>
                                                        <div class="option-field">
                                                            <label for="digital-scroll-sensitivity">Scroll Sensitivity:</label>
                                                            <input type="range" id="digital-scroll-sensitivity" min="0.2" max="5" step="0.1" value="1.0">
                                                        </div>
                                                        <div class="option-field">
                                                            <label>
                                                                <input type="checkbox" id="digital-show-connections" checked> Show Connections
                                                            </label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="display-editor-tab" class="tab-content" role="tabpanel" aria-labelledby="display-editor-tab-btn">
                                        <div class="space-editor-container">
                                            <div class="space-canvas" id="display-canvas">
                                                <div class="zoom-controls">
                                                    <button type="button" class="zoom-btn zoom-in-btn" id="display-zoom-in-btn" title="Zoom In">
                                                        <span class="zoom-icon">+</span>
                                                    </button>
                                                    <button type="button" class="zoom-btn zoom-out-btn" id="display-zoom-out-btn" title="Zoom Out">
                                                        <span class="zoom-icon">‚àí</span>
                                                    </button>
                                                    <button type="button" class="zoom-btn zoom-fit-btn" id="display-zoom-fit-btn" title="Zoom to Fit">
                                                        <span class="zoom-icon">‚õ∂</span>
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="properties-panel-container">
                                                <div class="properties-panel-header">
                                                    <div class="properties-panel-header-top">
                                                        <h4>Display Editor</h4>
                                                        <button id="add-display-btn" class="btn btn-primary btn-compact">+ Add Display</button>
                                                    </div>
                                                    <div class="layer-controls">
                                                        <label for="display-select">Display:</label>
                                                        <select id="display-select">
                                                            <option value="">No Display</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div id="display-properties-panel-content">
                                                    <p class="placeholder">Select a display or create a new one to start designing interface elements.</p>
                                                </div>
                                                <div class="options-panel-container">
                                                    <div class="options-panel-header">
                                                        <h4>UI Elements</h4>
                                                    </div>
                                                    <div id="display-options-panel-content">
                                                        <div class="option-field">
                                                            <button type="button" class="btn btn-secondary" id="add-display-element-btn" style="width: 100%; margin-bottom: 0.5rem;">+ Add Element</button>
                                                        </div>
                                                        <div class="option-field" style="display: none; grid-template-columns: repeat(3, 1fr); gap: 0.25rem;">
                                                            <button type="button" class="element-quick-btn" data-element-type="button" style="font-size: 0.75rem; padding: 0.3rem;">üîò Button</button>
                                                            <button type="button" class="element-quick-btn" data-element-type="textbox" style="font-size: 0.75rem; padding: 0.3rem;">üìù Input</button>
                                                            <button type="button" class="element-quick-btn" data-element-type="label" style="font-size: 0.75rem; padding: 0.3rem;">üè∑Ô∏è Label</button>
                                                            <button type="button" class="element-quick-btn" data-element-type="checkbox" style="font-size: 0.75rem; padding: 0.3rem;">‚òëÔ∏è Checkbox</button>
                                                            <button type="button" class="element-quick-btn" data-element-type="dropdown" style="font-size: 0.75rem; padding: 0.3rem;">üîΩ Dropdown</button>
                                                            <button type="button" class="element-quick-btn" data-element-type="slider" style="font-size: 0.75rem; padding: 0.3rem;">üéöÔ∏è Slider</button>
                                                            <button type="button" class="element-quick-btn" data-element-type="panel" style="font-size: 0.75rem; padding: 0.3rem;">üìã Panel</button>
                                                            <button type="button" class="element-quick-btn" data-element-type="card" style="font-size: 0.75rem; padding: 0.3rem;">üÉè Card</button>
                                                            <button type="button" class="element-quick-btn" data-element-type="list" style="font-size: 0.75rem; padding: 0.3rem;">üìú List</button>
                                                            <button type="button" class="element-quick-btn" data-element-type="image" style="font-size: 0.75rem; padding: 0.3rem;">üñºÔ∏è Image</button>
                                                            <button type="button" class="element-quick-btn" data-element-type="table" style="font-size: 0.75rem; padding: 0.3rem;">üìã Table</button>
                                                            <button type="button" class="element-quick-btn" data-element-type="modal" style="font-size: 0.75rem; padding: 0.3rem;">üì± Modal</button>
                                                        </div>
                                                        <div class="option-field">
                                                            <label for="display-scroll-sensitivity">Scroll Sensitivity:</label>
                                                            <input type="range" id="display-scroll-sensitivity" min="0.2" max="5" step="0.1" value="2.5">
                                                        </div>
                                                        <div class="option-field">
                                                            <label>
                                                                <input type="checkbox" id="display-show-grid" checked> Show Grid
                                                            </label>
                                                        </div>
                                                        <div class="option-field">
                                                            <label>
                                                                <input type="checkbox" id="display-snap-x-enabled" checked> Enable Horizontal Snapping
                                                            </label>
                                                        </div>
                                                        <div class="option-field">
                                                            <label>
                                                                <input type="checkbox" id="display-snap-y-enabled" checked> Enable Vertical Snapping
                                                            </label>
                                                        </div>
                                                        <div class="option-field">
                                                            <label for="display-snap-tolerance">Snap Tolerance:</label>
                                                            <input type="number" id="display-snap-tolerance" value="10" min="1" max="50" step="1">
                                                            <span>px</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Metrics Mode: Three tabs that reuse existing components -->
                        <div class="metrics-mode-layout" style="display: none;">
                            <div class="left-panel-tabs">
                                <div class="tab-bar">
                                    <button class="left-tab-btn active" data-left-tab="json-editor">JSON Editor</button>
                                    <button class="left-tab-btn" data-left-tab="simulation-render">Simulation Render</button>
                                    <button class="left-tab-btn" data-left-tab="space-editor">Space Editor</button>
                                    <button class="left-tab-btn" data-left-tab="digital-space">Digital Locations</button>
                                    <button class="left-tab-btn" data-left-tab="display-editor">Display Editor</button>
                                </div>
                                
                                <div class="left-tab-content-wrapper">
                                    <!-- JSON Editor Tab: Create new editor instance -->
                                    <div id="json-editor-left-tab" class="left-tab-content active">
                                        <div class="panel-content">
                                            <div id="json-editor-metrics-container" class="json-editor-resize-container">
                                                <div id="json-editor-metrics"></div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Simulation Render Tab: Move existing components here -->
                                    <div id="simulation-render-left-tab" class="left-tab-content">
                                        <!-- Existing simulation content will be moved here -->
                                    </div>
                                    
                                    <!-- Space Editor Tab: Move existing components here -->
                                    <div id="space-editor-left-tab" class="left-tab-content">
                                        <!-- Existing space editor content will be moved here -->
                                    </div>
                                    
                                    <!-- Digital Space Tab: Move existing components here -->
                                    <div id="digital-space-left-tab" class="left-tab-content">
                                        <!-- Existing digital space content will be moved here -->
                                    </div>
                                    
                                    <!-- Display Editor Tab: Move existing components here -->
                                    <div id="display-editor-left-tab" class="left-tab-content">
                                        <!-- Existing display editor content will be moved here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="metrics-editor-panel" id="metrics-editor-panel" style="display: none;">
                        <div class="resize-handle-vertical metrics-resize"></div>
                        <div class="panel-content">
                            <div class="metrics-tab-bar">
                                <button class="metrics-tab-btn active" data-tab="catalog">metrics-catalog-custom.json</button>
                                <button class="metrics-tab-btn" data-tab="validator">simulation-validator-custom.js</button>
                            </div>
                            <div class="metrics-tab-content-wrapper">
                                <div id="metrics-catalog-tab" class="metrics-tab-content active">
                                    <div id="metrics-catalog-editor"></div>
                                </div>
                                <div id="metrics-validator-tab" class="metrics-tab-content">
                                    <div id="metrics-validator-editor"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="playground-bottom">
                    <div class="resize-handle-horizontal"></div>
                    <div class="validation-panel" role="region" aria-labelledby="validation-panel-title">
                        <div class="validation-header">
                            <div class="validation-inline">
                                <span id="validation-panel-title">Validation</span>
                                <div
                                    class="validation-indicator success"
                                    id="json-status"
                                    title="Click for details"
                                    role="status"
                                    aria-live="polite"
                                >
                                    ‚úì Valid JSON
                                </div>
                            </div>
                            
                            <!-- Validation Controls -->
                            <div class="validation-controls" id="validation-controls">
                                <div class="validation-filters">
                                    <label for="validation-filter">Show:</label>
                                    <select id="validation-filter">
                                        <option value="all">All Metrics</option>
                                        <option value="errors">Errors Only</option>
                                        <option value="warnings">Warnings Only</option>
                                        <option value="suggestions">Suggestions Only</option>
                                        <option value="passed">Passed Only</option>
                                        <option value="custom">Custom Only</option>
                                        <option value="builtin">Built-in Only</option>
                                    </select>
                                </div>
                                
                                <!-- Inline Statistics -->
                                <div class="validation-stats-inline">
                                    <span class="stat-item clickable" data-filter="all" id="total-stat">
                                        <span class="stat-count" id="total-metrics-count">0</span>
                                        <span class="stat-label">Total</span>
                                    </span>
                                    <span class="stat-item clickable" data-filter="errors" id="error-stat">
                                        <span class="stat-count error" id="error-metrics-count">0</span>
                                        <span class="stat-label">Errors</span>
                                    </span>
                                    <span class="stat-item clickable" data-filter="warnings" id="warning-stat">
                                        <span class="stat-count warning" id="warning-metrics-count">0</span>
                                        <span class="stat-label">Warnings</span>
                                    </span>
                                    <span class="stat-item clickable" data-filter="suggestions" id="suggestion-stat">
                                        <span class="stat-count suggestion" id="suggestion-metrics-count">0</span>
                                        <span class="stat-label">Suggestions</span>
                                    </span>
                                    <span class="stat-item clickable" data-filter="passed" id="passed-stat">
                                        <span class="stat-count success" id="success-metrics-count">0</span>
                                        <span class="stat-label">Passed</span>
                                    </span>
                                    <button id="run-validation-btn" class="btn-primary" style="display: none; margin-left: 1rem;" title="Run validation manually">Run Validation</button>
                                </div>
                                
                                <div class="metrics-mode-controls" id="metrics-mode-controls" style="display: none;">
                                    <button id="run-custom-validation" class="btn-primary">Run Custom Validation</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="validation-content" id="validation-content">
                            <div class="validation-compact" id="validation-compact">
                                <div class="validation-results-grouped" id="validation-results-grouped">
                                    <!-- Errors Group -->
                                    <div class="validation-group error" id="errors-group" style="display: none;">
                                        <div class="validation-group-content" id="errors-group-content">
                                            <!-- Error results will be populated here -->
                                        </div>
                                    </div>
                                    
                                    <!-- Warnings Group -->
                                    <div class="validation-group warning" id="warnings-group" style="display: none;">
                                        <div class="validation-group-content" id="warnings-group-content">
                                            <!-- Warning results will be populated here -->
                                        </div>
                                    </div>
                                    
                                    <!-- Suggestions Group -->
                                    <div class="validation-group suggestion" id="suggestions-group" style="display: none;">
                                        <div class="validation-group-content" id="suggestions-group-content">
                                            <!-- Suggestion results will be populated here -->
                                        </div>
                                    </div>
                                    
                                    <!-- Passed Group (collapsible by default) -->
                                    <div class="validation-group success collapsible" id="passed-group" style="display: none;">
                                        <div class="validation-group-content" id="passed-group-content">
                                            <!-- Passed results will be populated here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Dialog overlay -->
        <div id="dialog-overlay" class="dialog-overlay" style="display: none" role="dialog" aria-modal="true" aria-live="polite">
            <div class="dialog" id="dialog-content">
                <!-- Dialog content will be inserted here -->
            </div>
        </div>

        <!-- Save Simulation Modal -->
        <div id="save-modal" class="dialog-overlay" style="display: none;" role="dialog" aria-modal="true" aria-labelledby="save-modal-title">
            <div class="dialog">
                <h3 id="save-modal-title">Save Simulation</h3>
                <div class="save-method-selection">
                    <div class="save-method-options">
                        <label class="save-method-option">
                            <input type="radio" name="save-method" value="local" id="save-local-radio">
                            <span class="save-method-content">
                                <strong>üíæ Save to Local File</strong>
                                <small>Save directly to your computer</small>
                            </span>
                        </label>
                        <label class="save-method-option">
                            <input type="radio" name="save-method" value="cloud" id="save-cloud-radio" checked>
                            <span class="save-method-content">
                                <strong>‚òÅÔ∏è Save to Cloud</strong>
                                <small>Get a shareable save code to load from any device</small>
                            </span>
                        </label>
                    </div>
                </div>
                <div class="save-warning" id="cloud-privacy-warning">
                    <p><strong>‚ö†Ô∏è Privacy Notice</strong></p>
                    <p>Your simulation is currently private and locally stored in your browser. By continuing, you agree that your simulation will be stored on a server so it can later be retrieved. Do not store confidential information in simulations, as anyone who guesses your save code will be able to see your simulation in full.</p>
                    <label>
                        <input type="checkbox" id="privacy-consent-checkbox">
                        I understand and agree to the privacy terms above
                    </label>
                </div>
                <div class="local-save-name" id="local-save-name" style="display: none;">
                    <label for="local-file-name">File Name:</label>
                    <input type="text" id="local-file-name" placeholder="Enter simulation name..." maxlength="50">
                    <small>A descriptive name for your simulation (e.g., "Restaurant Kitchen Process"). Do not include file extension.</small>
                    
                    <div class="custom-metrics-save-option" id="custom-metrics-save-option" style="margin-top: 1rem;">
                        <label>
                            <input type="checkbox" id="include-custom-metrics-checkbox">
                            Include custom metrics in save file (creates .zip with simulation + metrics)
                        </label>
                        <small id="custom-metrics-help" style="display: block; margin-top: 0.25rem; color: var(--text-light);">
                            When enabled, saves your custom metrics catalog and validator code along with the simulation
                        </small>
                    </div>
                </div>
                <div id="save-success" style="display: none;" class="save-success">
                    <p><strong>‚úÖ Save Successful!</strong></p>
                    <div id="cloud-save-result">
                        <p>Your save code is:</p>
                        <div class="save-code-display">
                            <input type="text" id="save-code-result" readonly>
                            <button id="copy-save-code-btn" class="btn-secondary">Copy</button>
                        </div>
                        <p><small>Keep this code safe - you'll need it to load your simulation later.</small></p>
                    </div>
                    <div id="local-save-result" style="display: none;">
                        <p>File saved successfully to your computer!</p>
                        <p><strong>Saved as:</strong> <span id="saved-filename"></span></p>
                    </div>
                </div>
                <div id="save-loading" style="display: none;" class="save-loading" role="status" aria-live="polite">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div style="width: 20px; height: 20px; border: 2px solid #ddd; border-top: 2px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite;" aria-hidden="true"></div>
                        Saving simulation...
                    </div>
                </div>
                <div class="dialog-buttons">
                    <button type="button" class="btn-secondary" id="save-cancel-btn">Cancel</button>
                    <button type="button" class="btn-primary" id="save-confirm-btn" disabled>Save Simulation</button>
                </div>
            </div>
        </div>

        <!-- Add Task Modal -->
        <div id="add-task-modal" class="dialog-overlay" style="display: none;" role="dialog" aria-modal="true" aria-labelledby="add-task-modal-title">
            <div class="dialog">
                <h3 id="add-task-modal-title">Add Task</h3>
                <div class="modal-content">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="task-id-input">Task ID: <span class="required-indicator">*</span></label>
                            <input type="text" id="task-id-input" placeholder="task_name" required>
                            <div class="field-error" id="task-id-error"></div>
                            <small class="field-help">Use lowercase letters, numbers, and underscores</small>
                        </div>
                        <div class="form-group">
                            <label for="task-emoji-input">Emoji: <span class="required-indicator">*</span></label>
                            <input type="text" id="task-emoji-input" placeholder="üîß" maxlength="2" required>
                            <div class="field-error" id="task-emoji-error"></div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="task-actor-select">Actor: <span class="required-indicator">*</span></label>
                            <select id="task-actor-select" required>
                                <option value="">Select actor...</option>
                            </select>
                            <small class="field-help">
                                Any object can act as an actor (e.g., equipment self-maintenance, product self-processing)
                            </small>
                            <div class="field-error" id="task-actor-error"></div>
                        </div>
                        <div class="form-group">
                            <label for="task-location-select">Location:</label>
                            <select id="task-location-select">
                                <option value="">Select location...</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="task-start-input">Start Time: <span class="required-indicator">*</span></label>
                            <input type="text" id="task-start-input" placeholder="HH:MM" required pattern="[0-2][0-9]:[0-5][0-9]">
                            <div class="field-error" id="task-start-error"></div>
                        </div>
                        <div class="form-group">
                            <div class="time-input-toggle">
                                <label>
                                    <input type="radio" name="time-input-mode" value="duration" checked> Duration
                                </label>
                                <label>
                                    <input type="radio" name="time-input-mode" value="end-time"> End Time
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <div id="duration-input-group">
                                <label for="task-duration-input">Duration (minutes): <span class="required-indicator">*</span></label>
                                <input type="number" id="task-duration-input" placeholder="30" min="1" required>
                                <div class="field-error" id="task-duration-error"></div>
                            </div>
                            <div id="end-time-input-group" style="display: none;">
                                <label for="task-end-time-input">End Time: <span class="required-indicator">*</span></label>
                                <input type="text" id="task-end-time-input" placeholder="HH:MM" pattern="[0-2][0-9]:[0-5][0-9]">
                                <div class="field-error" id="task-end-time-error"></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="task-schedule-preview">
                                <label>Schedule Preview:</label>
                                <div id="task-schedule-text">-</div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="task-depends-input">Dependencies (comma-separated task IDs):</label>
                        <input type="text" id="task-depends-input" placeholder="task1, task2" list="task-depends-datalist">
                        <datalist id="task-depends-datalist">
                            <!-- Task IDs will be populated here -->
                        </datalist>
                        <div class="field-error" id="task-depends-error"></div>
                        <small class="field-help">Optional: Enter task IDs that must complete before this task</small>
                    </div>

                    <div class="interactions-section">
                        <div class="section-header">
                            <h4>Interactions
                                <span class="help-icon" title="Interactions define how this task modifies objects, such as changing properties, adding/removing objects, or moving digital items">‚ìò</span>
                            </h4>
                            <button type="button" class="btn-secondary" id="add-interaction-btn">+ Add Interaction</button>
                        </div>
                        <div class="interaction-templates" id="interaction-templates">
                            <small>Quick templates:</small>
                            <button type="button" class="btn-template" data-template="change-state">Change State</button>
                            <button type="button" class="btn-template" data-template="modify-quantity">Modify Quantity</button>
                            <button type="button" class="btn-template" data-template="create-object">Create Object</button>
                        </div>
                        <div id="interactions-container">
                            <!-- Interactions will be dynamically added here -->
                        </div>
                    </div>
                </div>
                <div class="dialog-buttons">
                    <button type="button" class="btn-secondary" id="task-cancel-btn">Cancel</button>
                    <button type="button" class="btn-primary" id="task-add-btn" disabled>Add Task</button>
                </div>
            </div>
        </div>

        <!-- Add Object Modal -->
        <div id="add-object-modal" class="dialog-overlay" style="display: none;" role="dialog" aria-modal="true" aria-labelledby="add-object-modal-title">
            <div class="dialog">
                <h3 id="add-object-modal-title">Add Object</h3>
                <div class="modal-content">
                    <div class="form-group">
                        <label for="object-type-select">Object Type: <span class="required-indicator">*</span></label>
                        <select id="object-type-select">
                            <option value="">Select type...</option>
                            <option value="actor">Actor (People, AI agents)</option>
                            <option value="equipment">Equipment (Tools, machines)</option>
                            <option value="resource">Resource (Materials, consumables)</option>
                            <option value="product">Product (Outputs, deliverables)</option>
                            <option value="custom">Custom (Define your own)</option>
                        </select>
                        <div class="field-error" id="object-type-error"></div>
                    </div>
                    <div class="form-group">
                        <label for="object-id-input">ID: <span class="required-indicator">*</span></label>
                        <div class="input-with-validation">
                            <input type="text" id="object-id-input" placeholder="unique_identifier">
                            <span class="validation-icon"></span>
                        </div>
                        <div class="field-error" id="object-id-error"></div>
                        <div class="field-hint">Use lowercase with underscores (e.g., my_object_1)</div>
                    </div>
                    <div class="form-group">
                        <label for="object-name-input">Name: <span class="required-indicator">*</span></label>
                        <div class="input-with-validation">
                            <input type="text" id="object-name-input" placeholder="Display Name">
                            <span class="validation-icon"></span>
                        </div>
                        <div class="field-error" id="object-name-error"></div>
                    </div>
                    <div class="form-group">
                        <label for="object-emoji-input">Emoji:</label>
                        <div class="input-with-validation">
                            <input type="text" id="object-emoji-input" placeholder="üîß" maxlength="2">
                            <span class="validation-icon"></span>
                        </div>
                        <div class="field-error" id="object-emoji-error"></div>
                        <div class="field-hint">Optional: Add a single emoji character</div>
                    </div>
                    <div id="object-type-specific-fields">
                        <!-- Type-specific fields will be dynamically inserted here -->
                    </div>
                </div>
                <div class="dialog-buttons">
                    <button type="button" class="btn-secondary" id="object-cancel-btn">Cancel</button>
                    <button type="button" class="btn-primary" id="object-add-btn" disabled>
                        <span class="btn-text">Add Object</span>
                        <span class="btn-spinner" style="display: none;">Adding...</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Load Simulation Modal -->
        <div id="load-modal" class="dialog-overlay" style="display: none;" role="dialog" aria-modal="true" aria-labelledby="load-modal-title">
            <div class="dialog">
                <h3 id="load-modal-title">Load Simulation</h3>
                <div class="load-method-selection">
                    <div class="load-method-options">
                        <label class="load-method-option">
                            <input type="radio" name="load-method" value="local" id="load-local-radio">
                            <span class="load-method-content">
                                <strong>üíæ Load from Local File</strong>
                                <small>Browse and load from files saved on your computer</small>
                            </span>
                        </label>
                        <label class="load-method-option">
                            <input type="radio" name="load-method" value="cloud" id="load-cloud-radio" checked>
                            <span class="load-method-content">
                                <strong>‚òÅÔ∏è Load from Cloud</strong>
                                <small>Use a save code to load from the cloud</small>
                            </span>
                        </label>
                    </div>
                </div>
                <div id="cloud-load-section">
                    <p>Enter your 16-character save code to load a previously saved simulation:</p>
                    <div class="load-input-container">
                        <input type="text" id="load-code-input" placeholder="Enter save code..." maxlength="16">
                    </div>
                </div>
                <div id="local-load-section" style="display: none;">
                    <p>Click the button below to browse and select a simulation file from your computer:</p>
                    <div class="local-load-container">
                        <button type="button" id="browse-local-file-btn" class="btn-secondary">Browse Files</button>
                        <div id="selected-file-info" style="display: none; margin-top: 1rem;">
                            <p><strong>Selected file:</strong> <span id="selected-file-name"></span></p>
                        </div>
                    </div>
                </div>
                <div id="load-error" style="display: none;" class="load-error" role="alert" aria-live="assertive">
                    <p style="color: #d32f2f;"><strong>Error:</strong> <span id="load-error-message"></span></p>
                </div>
                <div id="load-loading" style="display: none;" class="load-loading" role="status" aria-live="polite">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div style="width: 20px; height: 20px; border: 2px solid #ddd; border-top: 2px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite;" aria-hidden="true"></div>
                        Loading simulation...
                    </div>
                </div>
                <div class="dialog-buttons">
                    <button type="button" class="btn-secondary" id="load-cancel-btn">Cancel</button>
                    <button type="button" class="btn-primary" id="load-confirm-btn">Load Simulation</button>
                </div>
            </div>
        </div>


        <div id="llm-info-overlay" class="dialog-overlay" style="display: none;" role="dialog" aria-modal="true" aria-labelledby="llm-info-title">
            <div class="dialog">
                <h3 id="llm-info-title">üöÄ Experimental AI Feature (Canary)</h3>
                <p>You are about to test UAW's integration with an experimental, built-in AI. This feature uses the new Prompt API which is under active development.</p>
                
                <strong>Requirements:</strong>
                <ul>
                    <li>You must be using <strong>Google Chrome Canary</strong>.</li>
                    <li>The API must be enabled via a feature flag.</li>
                </ul>
                
                <strong>How to Enable:</strong>
                <ol>
                    <li>Download and install <a href="https://www.google.com/chrome/canary/" target="_blank">Google Chrome Canary</a>.</li>
                    <li>In Canary, go to <code>chrome://flags/#prompt-api-for-gemini-nano</code> <strong>and</strong> <code>chrome://flags/#optimization-guide-on-device-model</code>, set both to <strong>Enabled</strong>, and restart the browser.</li>
                    <li>After around 15 minutes, you should see a new entry in <code>chrome://components/</code> - Optimization Guide On Device Model. Wait for this to be on 'Status - Updated' before clicking continue.</li>
                </ol>
                <p><small>This API is experimental and subject to change. It may not work on all devices.</small></p>

                <div class="dialog-buttons">
                    <button type="button" class="btn-secondary" id="llm-cancel-btn">Cancel</button>
                    <button type="button" class="btn-primary" id="llm-proceed-btn">Continue</button>
                </div>
            </div>
        </div>

        <!-- Overlay 2: The Chat Interface -->
        <div id="llm-chat-overlay" class="dialog-overlay" style="display: none;" role="dialog" aria-modal="true" aria-labelledby="llm-chat-title">
            <div class="dialog" style="max-width: 600px; display: flex; flex-direction: column;">
                <h3 id="llm-chat-title">Chat with Built-in AI</h3>
                <div id="llm-chat-history" style="flex: 1; overflow-y: auto; border: 1px solid var(--border-color); padding: 1rem; border-radius: 4px; min-height: 300px; margin-bottom: 1rem;"></div>
                <div id="llm-thinking-indicator" style="display: none; font-style: italic; color: var(--text-light); margin-bottom: 1rem;">AI is thinking...</div>
                <form id="llm-chat-form">
                    <div style="display: flex; gap: 1rem;">
                        <input type="text" id="llm-chat-input" placeholder="Ask a question about your simulation..." style="flex: 1;">
                        <button type="submit" class="btn-primary">Send</button>
                    </div>
                </form>
                <div class="dialog-buttons" style="justify-content: center;">
                    <button type="button" class="btn-secondary" id="llm-chat-close-btn">Close</button>
                </div>
            </div>
        </div>

        <!-- Feedback Modal -->
        <div id="feedback-modal" class="dialog-overlay" style="display: none;" role="dialog" aria-modal="true" aria-labelledby="feedback-modal-title">
            <div class="dialog">
                <h3 id="feedback-modal-title">Send Feedback</h3>
                <p>Help us improve the Simulation Playground by sharing your suggestions and feedback.</p>
                
                <form id="feedback-form" class="feedback-form">
                    <div class="feedback-form-field">
                        <label for="feedback-name">Name (optional)</label>
                        <input type="text" id="feedback-name" name="name" placeholder="Your name">
                    </div>
                    
                    <div class="feedback-form-field">
                        <label for="feedback-email">Email (optional)</label>
                        <input type="email" id="feedback-email" name="email" placeholder="your@email.com">
                    </div>
                    
                    <div class="feedback-form-field">
                        <label for="feedback-subject">Subject</label>
                        <input type="text" id="feedback-subject" name="subject" placeholder="Brief description of your feedback" required>
                    </div>
                    
                    <div class="feedback-form-field">
                        <label for="feedback-body">Feedback Details</label>
                        <textarea id="feedback-body" name="message" placeholder="Please describe your feedback in detail..." required></textarea>
                    </div>
                    
                    <div class="feedback-actions">
                        <button type="button" id="cancel-feedback" class="btn-secondary">Cancel</button>
                        <button type="submit" id="send-feedback" class="btn-primary">Send Feedback</button>
                    </div>
                </form>
                
                <div id="feedback-message" class="feedback-message" style="display: none;"></div>
            </div>
        </div>

        <!-- Add Metric Modal -->
        <div id="add-metric-modal" class="dialog-overlay" style="display: none;" role="dialog" aria-modal="true" aria-labelledby="add-metric-modal-title">
            <div class="dialog" style="max-width: 600px;">
                <h3 id="add-metric-modal-title">üîß Add Custom Metric</h3>
                <p>Create a new validation metric that will be automatically inserted into your metrics catalog and validator.</p>
                
                <form id="add-metric-form" class="metric-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="metric-name-input">Metric Name:</label>
                            <input type="text" id="metric-name-input" placeholder="e.g., Task Duration Validation" required>
                            <small>A descriptive name for your validation rule</small>
                        </div>
                        <div class="form-group">
                            <label for="metric-emoji-input">Emoji:</label>
                            <input type="text" id="metric-emoji-input" placeholder="üîß" maxlength="2" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="metric-category-input">Category:</label>
                        <select id="metric-category-input" required>
                            <option value="">Select category...</option>
                            <option value="Custom Validation">Custom Validation</option>
                            <option value="Resource Flow">Resource Flow</option>
                            <option value="Scheduling">Scheduling</option>
                            <option value="Quality Assurance">Quality Assurance</option>
                            <option value="Performance">Performance</option>
                            <option value="Safety">Safety</option>
                            <option value="Compliance">Compliance</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="metric-severity-input">Severity:</label>
                        <select id="metric-severity-input" required>
                            <option value="info">Info - Informational message</option>
                            <option value="warning" selected>Warning - Potential issue to review</option>
                            <option value="error">Error - Critical validation failure</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="metric-description-input">Description:</label>
                        <textarea id="metric-description-input" placeholder="Describe what this metric validates and why it's important..." rows="3" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="metric-validation-logic">Validation Logic Template:</label>
                        <select id="metric-validation-logic">
                            <option value="basic">Basic Check - Simple validation pattern</option>
                            <option value="resource">Resource Check - Validate resource quantities/states</option>
                            <option value="timing">Timing Check - Validate task scheduling and timing</option>
                            <option value="dependency">Dependency Check - Validate task dependencies</option>
                            <option value="custom">Custom Logic - Write your own validation</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="metric-has-params"> 
                            This metric accepts custom parameters
                        </label>
                        <div id="metric-params-section" style="display: none; margin-top: 0.5rem;">
                            <textarea id="metric-params-input" placeholder='{"param1": "default_value", "param2": 42}' rows="2"></textarea>
                            <small>JSON object defining parameter names and default values</small>
                        </div>
                    </div>
                    
                    <!-- Auto-generated fields at bottom -->
                    <div class="form-row auto-generated-fields">
                        <div class="form-group">
                            <label for="metric-id-input">Metric ID:</label>
                            <input type="text" id="metric-id-input" placeholder="custom.validation.task_duration" readonly>
                            <small id="metric-id-status">Auto-generated based on category and name</small>
                        </div>
                        <div class="form-group">
                            <label for="metric-function-input">Function Name:</label>
                            <input type="text" id="metric-function-input" placeholder="validateTaskDuration" readonly>
                            <small id="metric-function-status">Auto-generated JavaScript function name</small>
                        </div>
                    </div>
                </form>
                
                <div class="dialog-buttons">
                    <button type="button" class="btn-secondary" id="metric-cancel-btn">Cancel</button>
                    <button type="button" class="btn-primary" id="metric-add-btn">Add Metric</button>
                </div>
            </div>
        </div>

        <!-- Context Menu -->
        <div id="context-menu" class="context-menu" style="display: none;">
            <div class="context-menu-item" id="context-menu-edit">
                Edit
            </div>
            <div class="context-menu-item" id="context-menu-delete">
                Delete
            </div>
        </div>

        <!-- Drag Overlay for Resizing -->
        <div id="drag-overlay" class="drag-overlay"></div>

        <script src="/assets/js/context-menu.js" defer></script>
        <script src="/assets/js/html-sanitizer.js" defer></script>
        <!-- Smart Actions modules -->
        <script src="/assets/js/playground/smart-actions-markdown.js" defer></script>
        <script src="/assets/js/playground/smart-actions-context.js" defer></script>
        <script src="/assets/js/playground/smart-actions-client.js" defer></script>
        <script src="/assets/js/playground/smart-actions-diff.js" defer></script>
        <script src="/assets/js/playground/smart-actions-setup.js" defer></script>
        <script src="/assets/js/playground/smart-actions-ui.js" defer></script>

        <!-- Playground modules in dependency order -->
        <script src="/assets/js/playground/playground-utils.js" defer></script>
        <script src="/assets/js/playground/playground-ui.js" defer></script>
        <script src="/assets/js/playground/playground-validation.js" defer></script>

        <!-- Multi-period simulation modules -->
        <script src="/assets/js/playground/playground-multi-period.js" defer></script>
        <script src="/assets/js/playground/playground-view-controller.js" defer></script>
        <script src="/assets/js/playground/playground-calendar-view.js" defer></script>
        <script src="/assets/js/playground/playground-week-view.js" defer></script>

        <script src="/assets/js/playground/playground-timeline.js" defer></script>
        <script src="/assets/js/playground/playground-timeline-extensions.js" defer></script>
        <script src="/assets/js/playground/playground-digital-space.js" defer></script>
        <script src="/assets/js/playground/playground-display-editor.js" defer></script>
        <script src="/assets/js/playground/playground-save-load.js" defer></script>
        <script src="/assets/js/playground/playground-metrics-editor.js" defer></script>
        <script src="/assets/js/playground/playground-objects.js" defer></script>
        <script src="/assets/js/playground/playground-features.js" defer></script>
        <script src="/assets/js/playground/playground-editor.js" defer></script>
        <script src="/assets/js/playground/playground-core.js" defer></script>
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                const continueBtn = document.getElementById('welcome-continue-btn');
                const skipBtn = document.getElementById('skip-tutorial-btn');
                const startBtn = document.getElementById('start-tutorial-welcome-btn');
                const realStartBtn = document.getElementById('start-tutorial-btn');

                if (skipBtn && continueBtn) {
                    skipBtn.addEventListener('click', () => {
                        continueBtn.click();
                    });
                }

                if (startBtn && continueBtn && realStartBtn) {
                    startBtn.addEventListener('click', () => {
                        continueBtn.click();
                        realStartBtn.click();
                    });
                }
            });
        </script>
    </body>
</html>
