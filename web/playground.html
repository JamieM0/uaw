<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Simulation Playground - Universal Automation Wiki</title>
        <meta
            name="description"
            content="Interactive simulation playground for testing and visualizing automation workflows"
        />
        <link rel="stylesheet" href="/assets/css/main.css" />
        <link rel="stylesheet" href="/assets/css/components.css" />
        <link rel="stylesheet" href="/assets/css/simulation.css" />
        <link rel="stylesheet" href="/assets/css/space-editor.css" />
        <link rel="stylesheet" href="/assets/css/playground.css" />
        <link rel="stylesheet" href="/assets/css/drag-overlay.css" />
        <link rel="stylesheet" href="/assets/css/emoji-picker.css" />

        <link rel="icon" href="/favicon.ico" type="image/x-icon" />
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
            rel="stylesheet"
        />

        <script src="/assets/js/simulation-validator.js"></script>
        <script src="/assets/js/space-editor.js"></script>
        <script src="/assets/js/emoji-picker.js"></script>

        <script src="/assets/js/tutorial.js"></script>
        <script src="/assets/js/tutorial-validator.js"></script>
        <script src="/assets/js/simulation-player.js"></script>

        <!-- Monaco Editor for JSON syntax highlighting -->
        <script src="https://unpkg.com/monaco-editor@0.44.0/min/vs/loader.js"></script>
        
        <!-- JSZip - Load after Monaco to avoid AMD conflicts -->
        <script>
            // Load JSZip after Monaco Editor is ready to avoid AMD conflicts
            let jszipLoadAttempted = false;
            
            function loadJSZip() {
                if (jszipLoadAttempted) return;
                jszipLoadAttempted = true;
                
                // Temporarily disable AMD to force global registration TEST UPDATE 2
                const originalDefine = window.define;
                window.define = undefined;
                
                // Try local first
                const localScript = document.createElement('script');
                localScript.src = '/assets/js/jszip.min.js';
                localScript.onload = () => {
                    // Restore AMD after a brief delay
                    setTimeout(() => {
                        window.define = originalDefine;
                        if (typeof window.JSZip !== 'undefined') {
                            window.JSZipReady = true;
                        } else {
                            loadJSZipFromCDN();
                        }
                    }, 100);
                };
                localScript.onerror = () => {
                    window.define = originalDefine;
                    loadJSZipFromCDN();
                };
                document.head.appendChild(localScript);
            }
            
            function loadJSZipFromCDN() {
                // Temporarily disable AMD to force global registration
                const originalDefine = window.define;
                window.define = undefined;
                
                const cdnScript = document.createElement('script');
                cdnScript.src = 'https://unpkg.com/jszip@3.10.1/dist/jszip.min.js';
                cdnScript.onload = () => {
                    // Restore AMD after a brief delay
                    setTimeout(() => {
                        window.define = originalDefine;
                        if (typeof window.JSZip !== 'undefined') {
                            window.JSZipReady = true;
                        } else {
                            window.JSZipFailed = true;
                        }
                    }, 100);
                };
                cdnScript.onerror = () => {
                    window.define = originalDefine;
                    window.JSZipFailed = true;
                };
                document.head.appendChild(cdnScript);
            }
            
            // Load JSZip after DOM is ready and Monaco has had time to initialize
            document.addEventListener('DOMContentLoaded', () => {
                setTimeout(loadJSZip, 1000); // Wait 1 second for Monaco to settle
            });
        </script>

    </head>
    <body>
        <div id="welcome-overlay" class="dialog-overlay" style="display: flex;">
            <div class="dialog">
                <h2 class="special-subtitle">Welcome to the Simulation Playground!</h2>
                <p>This playground is an interactive tool for testing and visualising automation workflows.</p>
                <p>You can create, edit, and simulate complex processes to understand how they work and identify potential improvements.</p>
                <p>The Universal Automation Wiki (UAW) project, including this playground, is open source. We welcome contributions and feedback from the community. You can find the project on <a href="https://github.com/JamieM0/uaw" target="_blank">GitHub</a>.</p>
                <p>Please save your work regularly. The simulation playground is in early development, and we recommend keeping backups of your work. Remember some work may be stored in separate files ('metrics-catalog-custom.json' and 'simulation-validator-custom.js').</p>
                <p><strong>Tip:</strong> You can use emojis in any text field!
                <ul>
                    <li>Press <strong>Ctrl + .</strong> or <strong>Cmd + .</strong> to open the emoji selector.</li>
                    <li>In the JSON editor, right-click and choose 'Insert Emoji'.</li>
                </ul>
                </p>
                <p><strong>Tip:</strong> In space editors, you can quickly <strong>tap space</strong> to zoom to fit, or you can <strong>hold space</strong> to pan around.</p>
                <div class="dialog-buttons" style="margin-top: 1rem; justify-content: center; flex-direction: column;">
                    <div style="margin-bottom: 1rem;">
                        <label>
                            <input type="checkbox" id="dont-show-again" checked>
                            Don't show again
                        </label>
                    </div>
                    <button type="button" class="btn-primary" id="welcome-continue-btn">Continue</button>
                </div>
            </div>
        </div>
        <header class="playground-header">
            <div class="container header-container">
                <div class="logo">
                    <a href="/">
                        <img
                            src="/assets/images/logo-abbrev-inline.svg"
                            alt="Universal Automation Wiki Logo"
                        />
                    </a>
                </div>
                <h1 class="special-title">Playground</h1>
                <div class="header-actions">
                    <div class="json-editor-buttons">
                        <div class="dropdown">
                            <button id="simulation-library-btn" class="dropdown-toggle">Simulation Library ‚ñº</button>
                            <div id="simulation-library-dropdown" class="dropdown-content">
                                <!-- Simulation options will be populated here -->
                            </div>
                        </div>
                        <button id="format-json-btn">Format JSON</button>
                        <button id="clear-editor-btn">Clear</button>
                    </div>

                    <div class="simulation-buttons">
                        <button class="action-btn" id="add-object-btn">
                            + Object
                        </button>
                        <button class="action-btn" id="add-task-btn">
                            + Task
                        </button>
                    </div>

                    <div class="control-buttons">
                        <button id="metrics-mode-toggle" class="mode-toggle-btn" title="Toggle Metrics Editor Mode">
                            Open Metrics Editor
                        </button>
                        <button id="add-metric-btn" class="btn btn-secondary" style="display: none;" title="Add Custom Metric">
                            + Add Metric
                        </button>
                        <button id="render-simulation-btn" class="hidden">
                            Render
                        </button>
                        <button id="auto-render-toggle" class="hidden">Auto-render: ON</button>
                        <button
                            id="fullscreen-btn"
                            class="fullscreen-btn primary"
                            title="Toggle fullscreen simulation view"
                        >
                            ‚õ∂
                        </button>
                        <button
                            id="undo-btn"
                            class="undo-button"
                            disabled
                            title="Undo last change (Ctrl+Z)"
                        >
                            ‚Ü∂ Undo
                        </button>
                    </div>

                    <div class="player-controls">
                        <button id="player-play-pause-btn" title="Play/Pause Simulation">‚ñ∂Ô∏è</button>
                        <div class="player-time-display">
                            <span id="player-current-time">00:00</span>
                        </div>
                        <div class="player-speed-control">
                            <label for="player-speed-select">Speed:</label>
                            <select id="player-speed-select">
                                <option value="0.5">0.5x</option>
                                <option value="1" selected>1x</option>
                                <option value="2">2x</option>
                                <option value="5">5x</option>
                                <option value="10">10x</option>
                            </select>
                        </div>
                    </div>

                    <div class="action-buttons">
                        <!-- New Help Dropdown Menu -->
                        <div class="dropdown">
                            <button class="action-btn">Help</button>
                            <div class="dropdown-content">
                                <a href="#" id="start-tutorial-btn">Start Tutorial</a>
                                <a href="#" id="start-llm-btn">Experimental LLM</a>
                                <a href="#" id="toggle-auto-validate-btn">Disable Auto-Validate</a>
                            </div>
                        </div>

                        <button id="load-simulation-btn" class="action-btn" title="Load simulation from save code">Load Simulation</button>
                        <button id="save-simulation-btn" class="action-btn" title="Save simulation and get save code">Save Simulation</button>
                        <button id="submit-btn" class="action-btn" title="Submit simulation to page" style="display: none;">Submit</button>
                        <button id="feedback-btn" class="action-btn" title="Send feedback about the playground">Feedback</button>
                    </div>
                </div>
            </div>
        </header>

        <main class="playground-main">
            <div id="tutorial-panel" class="tutorial-panel">
                <div class="tutorial-header">
                    <h3 id="tutorial-title">Tutorial</h3>
                    <button id="tutorial-exit-btn" class="tutorial-exit-btn" title="Exit Tutorial">√ó</button>
                </div>
                <div class="tutorial-content">
                    <div id="tutorial-instructions"></div>
                    <div id="tutorial-status" style="display: none; margin-top: 1rem;"></div>
                </div>
                <div class="tutorial-footer">
                    <button id="tutorial-prev-btn">Back</button>
                    <button id="tutorial-skip-btn" style="display: none;">Skip</button>
                    <button id="tutorial-next-btn" disabled>Next</button>
                </div>
            </div>
            
            <div style="display: flex; flex-direction: column; flex: 1; min-width: 0;">
                <div class="playground-top">
                    <div class="playground-left">
                        <!-- Standard Mode: Two panels side by side -->
                        <div class="standard-mode-layout">
                            <div class="json-editor-panel">
                                <div class="panel-header"></div>
                                <div class="panel-content">
                                    <div id="json-editor"></div>
                                </div>
                                <div class="resize-handle-vertical"></div>
                            </div>

                            <div class="simulation-panel">
                                <div class="tab-bar">
                                    <button class="tab-btn active" data-tab="timeline">Simulation Render</button>
                                    <button class="tab-btn" data-tab="space-editor">Space Editor</button>
                                    <button class="tab-btn" data-tab="digital-space">Digital Locations</button>
                                    <button class="tab-btn" data-tab="display-editor">Display Editor</button>
                                </div>

                                <div class="tab-content-wrapper">
                                    <div id="simulation-tab" class="tab-content active">
                                        <div id="simulation-content" class="simulation-content">
                                            <!-- Existing simulation content -->
                                        </div>
                                        <div id="simulation-loading" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(255,255,255,0.9); padding: 1rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                <div style="width: 20px; height: 20px; border: 2px solid #ddd; border-top: 2px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                                                Rendering simulation...
                                            </div>
                                        </div>
                                    </div>
                                    <div id="space-editor-tab" class="tab-content">
                                        <div class="space-editor-container">
                                            <div class="space-canvas" id="space-canvas">
                                                <div class="zoom-controls">
                                                    <button type="button" class="zoom-btn zoom-in-btn" id="zoom-in-btn" title="Zoom In">
                                                        <span class="zoom-icon">+</span>
                                                    </button>
                                                    <button type="button" class="zoom-btn zoom-out-btn" id="zoom-out-btn" title="Zoom Out">
                                                        <span class="zoom-icon">‚àí</span>
                                                    </button>
                                                    <button type="button" class="zoom-btn zoom-fit-btn" id="zoom-fit-btn" title="Zoom to Fit">
                                                        <span class="zoom-icon">‚õ∂</span>
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="properties-panel-container">
                                                <div class="properties-panel-header">
                                                    <div class="properties-panel-header-top">
                                                        <h4>Properties</h4>
                                                        <button id="add-location-btn" class="btn btn-primary">+ Add</button>
                                                    </div>
                                                    <div class="layer-controls">
                                                        <label for="layer-filter">Layer:</label>
                                                        <select id="layer-filter">
                                                            <option value="all">All Layers</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div id="properties-panel-content">
                                                    <p class="placeholder">Select a location, or click '+ Add' to draw a new one.</p>
                                                </div>
                                                <div class="options-panel-container">
                                                    <div class="options-panel-header">
                                                        <h4>Options</h4>
                                                    </div>
                                                    <div id="options-panel-content">
                                                        <div class="option-field">
                                                            <label>
                                                                <input type="checkbox" id="snap-x-enabled" checked> Enable Vertical Snapping
                                                            </label>
                                                        </div>
                                                        <div class="option-field">
                                                            <label>
                                                                <input type="checkbox" id="snap-z-enabled" checked> Enable Horizontal Snapping
                                                            </label>
                                                        </div>
                                                        <div class="option-field">
                                                            <label for="snap-tolerance">Snap Tolerance:</label>
                                                            <input type="number" id="snap-tolerance" value="10" min="1" max="50" step="1">
                                                            <span>px</span>
                                                        </div>
                                                        <div class="option-field">
                                                            <label for="space-scroll-sensitivity">Scroll Sensitivity:</label>
                                                            <input type="range" id="space-scroll-sensitivity" min="0.2" max="5" step="0.1" value="1">
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="digital-space-tab" class="tab-content">
                                        <div class="space-editor-container">
                                            <div class="space-canvas" id="digital-space-canvas">
                                                <div class="zoom-controls">
                                                    <button type="button" class="zoom-btn zoom-in-btn" id="digital-zoom-in-btn" title="Zoom In">
                                                        <span class="zoom-icon">+</span>
                                                    </button>
                                                    <button type="button" class="zoom-btn zoom-out-btn" id="digital-zoom-out-btn" title="Zoom Out">
                                                        <span class="zoom-icon">‚àí</span>
                                                    </button>
                                                    <button type="button" class="zoom-btn zoom-fit-btn" id="digital-zoom-fit-btn" title="Zoom to Fit">
                                                        <span class="zoom-icon">‚õ∂</span>
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="properties-panel-container">
                                                <div class="properties-panel-header">
                                                    <div class="properties-panel-header-top">
                                                        <h4>Digital Locations</h4>
                                                        <button id="add-digital-location-btn" class="btn btn-primary btn-compact">+ Add Location</button>
                                                    </div>
                                                    <div class="layer-controls">
                                                        <label for="digital-layer-filter">Type:</label>
                                                        <select id="digital-layer-filter">
                                                            <option value="all">All Objects</option>
                                                            <option value="storage">Storage</option>
                                                            <option value="database">Database</option>
                                                            <option value="cache">Cache</option>
                                                            <option value="network">Network</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div id="digital-properties-panel-content">
                                                    <p class="placeholder">Select a digital location, or click '+ Add Location' to create a new storage area.</p>
                                                </div>
                                                <div class="options-panel-container">
                                                    <div class="options-panel-header">
                                                        <h4>Tools & Objects</h4>
                                                    </div>
                                                    <div id="digital-options-panel-content">
                                                        <div class="option-field">
                                                            <button type="button" class="btn btn-secondary full-width" id="add-digital-object-btn">+ Add Digital Object</button>
                                                        </div>
                                                        <div class="option-field">
                                                            <label for="digital-scroll-sensitivity">Scroll Sensitivity:</label>
                                                            <input type="range" id="digital-scroll-sensitivity" min="0.2" max="5" step="0.1" value="1.0">
                                                        </div>
                                                        <div class="option-field">
                                                            <label>
                                                                <input type="checkbox" id="digital-show-connections" checked> Show Connections
                                                            </label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="display-editor-tab" class="tab-content">
                                        <div class="space-editor-container">
                                            <div class="space-canvas" id="display-canvas">
                                                <div class="zoom-controls">
                                                    <button type="button" class="zoom-btn zoom-in-btn" id="display-zoom-in-btn" title="Zoom In">
                                                        <span class="zoom-icon">+</span>
                                                    </button>
                                                    <button type="button" class="zoom-btn zoom-out-btn" id="display-zoom-out-btn" title="Zoom Out">
                                                        <span class="zoom-icon">‚àí</span>
                                                    </button>
                                                    <button type="button" class="zoom-btn zoom-fit-btn" id="display-zoom-fit-btn" title="Zoom to Fit">
                                                        <span class="zoom-icon">‚õ∂</span>
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="properties-panel-container">
                                                <div class="properties-panel-header">
                                                    <div class="properties-panel-header-top">
                                                        <h4>Display Editor</h4>
                                                        <button id="add-display-btn" class="btn btn-primary btn-compact">+ Add Display</button>
                                                    </div>
                                                    <div class="layer-controls">
                                                        <label for="display-select">Display:</label>
                                                        <select id="display-select">
                                                            <option value="">No Display</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div id="display-properties-panel-content">
                                                    <p class="placeholder">Select a display or create a new one to start designing interface elements.</p>
                                                </div>
                                                <div class="options-panel-container">
                                                    <div class="options-panel-header">
                                                        <h4>UI Elements</h4>
                                                    </div>
                                                    <div id="display-options-panel-content">
                                                        <div class="option-field">
                                                            <button type="button" class="btn btn-secondary" id="add-display-element-btn" style="width: 100%; margin-bottom: 0.5rem;">+ Add Element</button>
                                                        </div>
                                                        <div class="option-field" style="display: flex; gap: 0.25rem; flex-wrap: wrap;">
                                                            <button type="button" class="element-quick-btn" data-element-type="button">üîò Button</button>
                                                            <button type="button" class="element-quick-btn" data-element-type="textbox">üìù Input</button>
                                                            <button type="button" class="element-quick-btn" data-element-type="label">üè∑Ô∏è Label</button>
                                                            <button type="button" class="element-quick-btn" data-element-type="panel">üìã Panel</button>
                                                        </div>
                                                        <div class="option-field">
                                                            <label for="display-scroll-sensitivity">Scroll Sensitivity:</label>
                                                            <input type="range" id="display-scroll-sensitivity" min="0.2" max="5" step="0.1" value="2.5">
                                                        </div>
                                                        <div class="option-field">
                                                            <label>
                                                                <input type="checkbox" id="display-show-grid" checked> Show Grid
                                                            </label>
                                                        </div>
                                                        <div class="option-field">
                                                            <label>
                                                                <input type="checkbox" id="display-snap-x-enabled" checked> Enable Horizontal Snapping
                                                            </label>
                                                        </div>
                                                        <div class="option-field">
                                                            <label>
                                                                <input type="checkbox" id="display-snap-y-enabled" checked> Enable Vertical Snapping
                                                            </label>
                                                        </div>
                                                        <div class="option-field">
                                                            <label for="display-snap-tolerance">Snap Tolerance:</label>
                                                            <input type="number" id="display-snap-tolerance" value="10" min="1" max="50" step="1">
                                                            <span>px</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Metrics Mode: Three tabs that reuse existing components -->
                        <div class="metrics-mode-layout" style="display: none;">
                            <div class="left-panel-tabs">
                                <div class="tab-bar">
                                    <button class="left-tab-btn active" data-left-tab="json-editor">JSON Editor</button>
                                    <button class="left-tab-btn" data-left-tab="simulation-render">Simulation Render</button>
                                    <button class="left-tab-btn" data-left-tab="space-editor">Space Editor</button>
                                    <button class="left-tab-btn" data-left-tab="digital-space">Digital Locations</button>
                                    <button class="left-tab-btn" data-left-tab="display-editor">Display Editor</button>
                                </div>
                                
                                <div class="left-tab-content-wrapper">
                                    <!-- JSON Editor Tab: Create new editor instance -->
                                    <div id="json-editor-left-tab" class="left-tab-content active">
                                        <div class="panel-content">
                                            <div id="json-editor-metrics-container" class="json-editor-resize-container">
                                                <div id="json-editor-metrics"></div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Simulation Render Tab: Move existing components here -->
                                    <div id="simulation-render-left-tab" class="left-tab-content">
                                        <!-- Existing simulation content will be moved here -->
                                    </div>
                                    
                                    <!-- Space Editor Tab: Move existing components here -->
                                    <div id="space-editor-left-tab" class="left-tab-content">
                                        <!-- Existing space editor content will be moved here -->
                                    </div>
                                    
                                    <!-- Digital Space Tab: Move existing components here -->
                                    <div id="digital-space-left-tab" class="left-tab-content">
                                        <!-- Existing digital space content will be moved here -->
                                    </div>
                                    
                                    <!-- Display Editor Tab: Move existing components here -->
                                    <div id="display-editor-left-tab" class="left-tab-content">
                                        <!-- Existing display editor content will be moved here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="metrics-editor-panel" id="metrics-editor-panel" style="display: none;">
                        <div class="resize-handle-vertical metrics-resize"></div>
                        <div class="panel-content">
                            <div class="metrics-tab-bar">
                                <button class="metrics-tab-btn active" data-tab="catalog">metrics-catalog-custom.json</button>
                                <button class="metrics-tab-btn" data-tab="validator">simulation-validator-custom.js</button>
                            </div>
                            <div class="metrics-tab-content-wrapper">
                                <div id="metrics-catalog-tab" class="metrics-tab-content active">
                                    <div id="metrics-catalog-editor"></div>
                                </div>
                                <div id="metrics-validator-tab" class="metrics-tab-content">
                                    <div id="metrics-validator-editor"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="playground-bottom">
                    <div class="resize-handle-horizontal"></div>
                    <div class="validation-panel">
                        <div class="validation-header">
                            <div class="validation-inline">
                                <span>Validation</span>
                                <div
                                    class="validation-indicator success"
                                    id="json-status"
                                    title="Click for details"
                                >
                                    ‚úì Valid JSON
                                </div>
                            </div>
                            
                            <!-- Validation Controls -->
                            <div class="validation-controls" id="validation-controls">
                                <div class="validation-filters">
                                    <label for="validation-filter">Show:</label>
                                    <select id="validation-filter">
                                        <option value="all">All Metrics</option>
                                        <option value="errors">Errors Only</option>
                                        <option value="warnings">Warnings Only</option>
                                        <option value="suggestions">Suggestions Only</option>
                                        <option value="passed">Passed Only</option>
                                        <option value="custom">Custom Only</option>
                                        <option value="builtin">Built-in Only</option>
                                    </select>
                                </div>
                                
                                <!-- Inline Statistics -->
                                <div class="validation-stats-inline">
                                    <span class="stat-item clickable" data-filter="all" id="total-stat">
                                        <span class="stat-count" id="total-metrics-count">0</span>
                                        <span class="stat-label">Total</span>
                                    </span>
                                    <span class="stat-item clickable" data-filter="errors" id="error-stat">
                                        <span class="stat-count error" id="error-metrics-count">0</span>
                                        <span class="stat-label">Errors</span>
                                    </span>
                                    <span class="stat-item clickable" data-filter="warnings" id="warning-stat">
                                        <span class="stat-count warning" id="warning-metrics-count">0</span>
                                        <span class="stat-label">Warnings</span>
                                    </span>
                                    <span class="stat-item clickable" data-filter="suggestions" id="suggestion-stat">
                                        <span class="stat-count suggestion" id="suggestion-metrics-count">0</span>
                                        <span class="stat-label">Suggestions</span>
                                    </span>
                                    <span class="stat-item clickable" data-filter="passed" id="passed-stat">
                                        <span class="stat-count success" id="success-metrics-count">0</span>
                                        <span class="stat-label">Passed</span>
                                    </span>
                                    <button id="run-validation-btn" class="btn-primary" style="display: none; margin-left: 1rem;" title="Run validation manually">Run Validation</button>
                                </div>
                                
                                <div class="metrics-mode-controls" id="metrics-mode-controls" style="display: none;">
                                    <button id="run-custom-validation" class="btn-primary">Run Custom Validation</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="validation-content" id="validation-content">
                            <div class="validation-compact" id="validation-compact">
                                <div class="validation-results-grouped" id="validation-results-grouped">
                                    <!-- Errors Group -->
                                    <div class="validation-group error" id="errors-group" style="display: none;">
                                        <div class="validation-group-content" id="errors-group-content">
                                            <!-- Error results will be populated here -->
                                        </div>
                                    </div>
                                    
                                    <!-- Warnings Group -->
                                    <div class="validation-group warning" id="warnings-group" style="display: none;">
                                        <div class="validation-group-content" id="warnings-group-content">
                                            <!-- Warning results will be populated here -->
                                        </div>
                                    </div>
                                    
                                    <!-- Suggestions Group -->
                                    <div class="validation-group suggestion" id="suggestions-group" style="display: none;">
                                        <div class="validation-group-content" id="suggestions-group-content">
                                            <!-- Suggestion results will be populated here -->
                                        </div>
                                    </div>
                                    
                                    <!-- Passed Group (collapsible by default) -->
                                    <div class="validation-group success collapsible" id="passed-group" style="display: none;">
                                        <div class="validation-group-content" id="passed-group-content">
                                            <!-- Passed results will be populated here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Dialog overlay -->
        <div id="dialog-overlay" class="dialog-overlay" style="display: none">
            <div class="dialog" id="dialog-content">
                <!-- Dialog content will be inserted here -->
            </div>
        </div>

        <!-- Save Simulation Modal -->
        <div id="save-modal" class="dialog-overlay" style="display: none;">
            <div class="dialog">
                <h3>Save Simulation</h3>
                <div class="save-method-selection">
                    <div class="save-method-options">
                        <label class="save-method-option">
                            <input type="radio" name="save-method" value="local" id="save-local-radio">
                            <span class="save-method-content">
                                <strong>üíæ Save to Local File</strong>
                                <small>Save directly to your computer</small>
                            </span>
                        </label>
                        <label class="save-method-option">
                            <input type="radio" name="save-method" value="cloud" id="save-cloud-radio" checked>
                            <span class="save-method-content">
                                <strong>‚òÅÔ∏è Save to Cloud</strong>
                                <small>Get a shareable save code to load from any device</small>
                            </span>
                        </label>
                    </div>
                </div>
                <div class="save-warning" id="cloud-privacy-warning">
                    <p><strong>‚ö†Ô∏è Privacy Notice</strong></p>
                    <p>Your simulation is currently private and locally stored in your browser. By continuing, you agree that your simulation will be stored on a server so it can later be retrieved. Do not store confidential information in simulations, as anyone who guesses your save code will be able to see your simulation in full.</p>
                    <label>
                        <input type="checkbox" id="privacy-consent-checkbox">
                        I understand and agree to the privacy terms above
                    </label>
                </div>
                <div class="local-save-name" id="local-save-name" style="display: none;">
                    <label for="local-file-name">File Name:</label>
                    <input type="text" id="local-file-name" placeholder="Enter simulation name..." maxlength="50">
                    <small>A descriptive name for your simulation (e.g., "Restaurant Kitchen Process"). Do not include file extension.</small>
                    
                    <div class="custom-metrics-save-option" id="custom-metrics-save-option" style="margin-top: 1rem;">
                        <label>
                            <input type="checkbox" id="include-custom-metrics-checkbox">
                            Include custom metrics in save file (creates .zip with simulation + metrics)
                        </label>
                        <small id="custom-metrics-help" style="display: block; margin-top: 0.25rem; color: var(--text-light);">
                            When enabled, saves your custom metrics catalog and validator code along with the simulation
                        </small>
                    </div>
                </div>
                <div id="save-success" style="display: none;" class="save-success">
                    <p><strong>‚úÖ Save Successful!</strong></p>
                    <div id="cloud-save-result">
                        <p>Your save code is:</p>
                        <div class="save-code-display">
                            <input type="text" id="save-code-result" readonly>
                            <button id="copy-save-code-btn" class="btn-secondary">Copy</button>
                        </div>
                        <p><small>Keep this code safe - you'll need it to load your simulation later.</small></p>
                    </div>
                    <div id="local-save-result" style="display: none;">
                        <p>File saved successfully to your computer!</p>
                        <p><strong>Saved as:</strong> <span id="saved-filename"></span></p>
                    </div>
                </div>
                <div id="save-loading" style="display: none;" class="save-loading">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div style="width: 20px; height: 20px; border: 2px solid #ddd; border-top: 2px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        Saving simulation...
                    </div>
                </div>
                <div class="dialog-buttons">
                    <button type="button" class="btn-secondary" id="save-cancel-btn">Cancel</button>
                    <button type="button" class="btn-primary" id="save-confirm-btn" disabled>Save Simulation</button>
                </div>
            </div>
        </div>

        <!-- Add Task Modal -->
        <div id="add-task-modal" class="dialog-overlay" style="display: none;">
            <div class="dialog" style="max-width: 700px;">
                <h3>Add Task</h3>
                <div class="modal-content">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="task-id-input">Task ID:</label>
                            <input type="text" id="task-id-input" placeholder="task_name">
                        </div>
                        <div class="form-group">
                            <label for="task-emoji-input">Emoji:</label>
                            <input type="text" id="task-emoji-input" placeholder="üîß" maxlength="2" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="task-actor-select">Actor:</label>
                            <select id="task-actor-select">
                                <option value="">Select actor...</option>
                            </select>
                            <small style="color: #666; font-size: 0.8rem; display: block; margin-top: 0.25rem;">
                                Any object can act as an actor (e.g., equipment self-maintenance, product self-processing)
                            </small>
                        </div>
                        <div class="form-group">
                            <label for="task-location-select">Location:</label>
                            <select id="task-location-select">
                                <option value="">Select location...</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <!-- Empty space to align with radio buttons -->
                        </div>
                        <div class="form-group">
                            <div class="time-input-toggle">
                                <label>
                                    <input type="radio" name="time-input-mode" value="duration" checked> Duration
                                </label>
                                <label>
                                    <input type="radio" name="time-input-mode" value="end-time"> End Time
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="task-start-input">Start Time:</label>
                            <input type="text" id="task-start-input" placeholder="HH:MM">
                        </div>
                        <div class="form-group">
                            <div id="duration-input-group">
                                <label for="task-duration-input">Duration (minutes):</label>
                                <input type="number" id="task-duration-input" placeholder="30" min="1">
                            </div>
                            <div id="end-time-input-group" style="display: none;">
                                <label for="task-end-time-input">End Time:</label>
                                <input type="text" id="task-end-time-input" placeholder="HH:MM">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="task-depends-input">Dependencies (comma-separated task IDs):</label>
                        <input type="text" id="task-depends-input" placeholder="task1, task2">
                    </div>
                    
                    <div class="interactions-section">
                        <div class="section-header">
                            <h4>Interactions</h4>
                            <button type="button" class="btn-secondary" id="add-interaction-btn">+ Add Interaction</button>
                        </div>
                        <div id="interactions-container">
                            <!-- Interactions will be dynamically added here -->
                        </div>
                    </div>
                </div>
                <div class="dialog-buttons">
                    <button type="button" class="btn-secondary" id="task-cancel-btn">Cancel</button>
                    <button type="button" class="btn-primary" id="task-add-btn">Add Task</button>
                </div>
            </div>
        </div>

        <!-- Add Object Modal -->
        <div id="add-object-modal" class="dialog-overlay" style="display: none;">
            <div class="dialog" style="max-width: 500px;">
                <h3>Add Object</h3>
                <div class="modal-content">
                    <div class="form-group">
                        <label for="object-type-select">Object Type:</label>
                        <select id="object-type-select">
                            <option value="">Select type...</option>
                            <option value="actor">Actor (People, AI agents)</option>
                            <option value="equipment">Equipment (Tools, machines)</option>
                            <option value="resource">Resource (Materials, consumables)</option>
                            <option value="product">Product (Outputs, deliverables)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="object-id-input">ID:</label>
                        <input type="text" id="object-id-input" placeholder="unique_identifier">
                    </div>
                    <div class="form-group">
                        <label for="object-name-input">Name:</label>
                        <input type="text" id="object-name-input" placeholder="Display Name">
                    </div>
                    <div class="form-group">
                        <label for="object-emoji-input">Emoji:</label>
                        <input type="text" id="object-emoji-input" placeholder="üîß" maxlength="2">
                    </div>
                    <div id="object-type-specific-fields">
                        <!-- Type-specific fields will be dynamically inserted here -->
                    </div>
                </div>
                <div class="dialog-buttons">
                    <button type="button" class="btn-secondary" id="object-cancel-btn">Cancel</button>
                    <button type="button" class="btn-primary" id="object-add-btn">Add Object</button>
                </div>
            </div>
        </div>

        <!-- Load Simulation Modal -->
        <div id="load-modal" class="dialog-overlay" style="display: none;">
            <div class="dialog">
                <h3>Load Simulation</h3>
                <div class="load-method-selection">
                    <div class="load-method-options">
                        <label class="load-method-option">
                            <input type="radio" name="load-method" value="local" id="load-local-radio">
                            <span class="load-method-content">
                                <strong>üíæ Load from Local File</strong>
                                <small>Browse and load from files saved on your computer</small>
                            </span>
                        </label>
                        <label class="load-method-option">
                            <input type="radio" name="load-method" value="cloud" id="load-cloud-radio" checked>
                            <span class="load-method-content">
                                <strong>‚òÅÔ∏è Load from Cloud</strong>
                                <small>Use a save code to load from the cloud</small>
                            </span>
                        </label>
                    </div>
                </div>
                <div id="cloud-load-section">
                    <p>Enter your 16-character save code to load a previously saved simulation:</p>
                    <div class="load-input-container">
                        <input type="text" id="load-code-input" placeholder="Enter save code..." maxlength="16">
                    </div>
                </div>
                <div id="local-load-section" style="display: none;">
                    <p>Click the button below to browse and select a simulation file from your computer:</p>
                    <div class="local-load-container">
                        <button type="button" id="browse-local-file-btn" class="btn-secondary">Browse Files</button>
                        <div id="selected-file-info" style="display: none; margin-top: 1rem;">
                            <p><strong>Selected file:</strong> <span id="selected-file-name"></span></p>
                        </div>
                    </div>
                </div>
                <div id="load-error" style="display: none;" class="load-error">
                    <p style="color: #d32f2f;"><strong>Error:</strong> <span id="load-error-message"></span></p>
                </div>
                <div id="load-loading" style="display: none;" class="load-loading">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div style="width: 20px; height: 20px; border: 2px solid #ddd; border-top: 2px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        Loading simulation...
                    </div>
                </div>
                <div class="dialog-buttons">
                    <button type="button" class="btn-secondary" id="load-cancel-btn">Cancel</button>
                    <button type="button" class="btn-primary" id="load-confirm-btn">Load Simulation</button>
                </div>
            </div>
        </div>

        <!-- Overlay 1: Information and Prerequisite Check (Updated) -->
        <div id="llm-info-overlay" class="dialog-overlay" style="display: none;">
            <div class="dialog">
                <h3>üöÄ Experimental AI Feature (Canary)</h3>
                <p>You are about to test UAW's integration with an experimental, built-in AI. This feature uses the new Prompt API which is under active development.</p>
                
                <strong>Requirements:</strong>
                <ul>
                    <li>You must be using <strong>Google Chrome Canary</strong>.</li>
                    <li>The API must be enabled via a feature flag.</li>
                </ul>
                
                <strong>How to Enable:</strong>
                <ol>
                    <li>Download and install <a href="https://www.google.com/chrome/canary/" target="_blank">Google Chrome Canary</a>.</li>
                    <li>In Canary, go to <code>chrome://flags/#prompt-api-for-gemini-nano</code> <strong>and</strong> <code>chrome://flags/#optimization-guide-on-device-model</code>, set both to <strong>Enabled</strong>, and restart the browser.</li>
                    <li>After around 15 minutes, you should see a new entry in <code>chrome://components/</code> - Optimization Guide On Device Model. Wait for this to be on 'Status - Updated' before clicking continue.</li>
                </ol>
                <p><small>This API is experimental and subject to change. It may not work on all devices.</small></p>

                <div class="dialog-buttons">
                    <button type="button" class="btn-secondary" id="llm-cancel-btn">Cancel</button>
                    <button type="button" class="btn-primary" id="llm-proceed-btn">Continue</button>
                </div>
            </div>
        </div>

        <!-- Overlay 2: The Chat Interface (No changes needed) -->
        <div id="llm-chat-overlay" class="dialog-overlay" style="display: none;">
            <div class="dialog" style="max-width: 600px; display: flex; flex-direction: column;">
                <h3 id="llm-chat-title">Chat with Built-in AI</h3>
                <div id="llm-chat-history" style="flex: 1; overflow-y: auto; border: 1px solid var(--border-color); padding: 1rem; border-radius: 4px; min-height: 300px; margin-bottom: 1rem;"></div>
                <div id="llm-thinking-indicator" style="display: none; font-style: italic; color: var(--text-light); margin-bottom: 1rem;">AI is thinking...</div>
                <form id="llm-chat-form">
                    <div style="display: flex; gap: 1rem;">
                        <input type="text" id="llm-chat-input" placeholder="Ask a question about your simulation..." style="flex: 1;">
                        <button type="submit" class="btn-primary">Send</button>
                    </div>
                </form>
                <div class="dialog-buttons" style="justify-content: center;">
                    <button type="button" class="btn-secondary" id="llm-chat-close-btn">Close</button>
                </div>
            </div>
        </div>

        <!-- Feedback Modal -->
        <div id="feedback-modal" class="dialog-overlay" style="display: none;">
            <div class="dialog">
                <h3>Send Feedback</h3>
                <p>Help us improve the Simulation Playground by sharing your suggestions and feedback.</p>
                
                <form id="feedback-form" class="feedback-form">
                    <div class="feedback-form-field">
                        <label for="feedback-name">Name (optional)</label>
                        <input type="text" id="feedback-name" name="name" placeholder="Your name">
                    </div>
                    
                    <div class="feedback-form-field">
                        <label for="feedback-email">Email (optional)</label>
                        <input type="email" id="feedback-email" name="email" placeholder="your@email.com">
                    </div>
                    
                    <div class="feedback-form-field">
                        <label for="feedback-subject">Subject</label>
                        <input type="text" id="feedback-subject" name="subject" placeholder="Brief description of your feedback" required>
                    </div>
                    
                    <div class="feedback-form-field">
                        <label for="feedback-body">Feedback Details</label>
                        <textarea id="feedback-body" name="message" placeholder="Please describe your feedback in detail..." required></textarea>
                    </div>
                    
                    <div class="feedback-actions">
                        <button type="button" id="cancel-feedback" class="btn-secondary">Cancel</button>
                        <button type="submit" id="send-feedback" class="btn-primary">Send Feedback</button>
                    </div>
                </form>
                
                <div id="feedback-message" class="feedback-message" style="display: none;"></div>
            </div>
        </div>

        <!-- Add Metric Modal -->
        <div id="add-metric-modal" class="dialog-overlay" style="display: none;">
            <div class="dialog" style="max-width: 600px;">
                <h3>üîß Add Custom Metric</h3>
                <p>Create a new validation metric that will be automatically inserted into your metrics catalog and validator.</p>
                
                <form id="add-metric-form" class="metric-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="metric-name-input">Metric Name:</label>
                            <input type="text" id="metric-name-input" placeholder="e.g., Task Duration Validation" required>
                            <small>A descriptive name for your validation rule</small>
                        </div>
                        <div class="form-group">
                            <label for="metric-emoji-input">Emoji:</label>
                            <input type="text" id="metric-emoji-input" placeholder="üîß" maxlength="2" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="metric-category-input">Category:</label>
                        <select id="metric-category-input" required>
                            <option value="">Select category...</option>
                            <option value="Custom Validation">Custom Validation</option>
                            <option value="Resource Flow">Resource Flow</option>
                            <option value="Scheduling">Scheduling</option>
                            <option value="Quality Assurance">Quality Assurance</option>
                            <option value="Performance">Performance</option>
                            <option value="Safety">Safety</option>
                            <option value="Compliance">Compliance</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="metric-severity-input">Severity:</label>
                        <select id="metric-severity-input" required>
                            <option value="info">Info - Informational message</option>
                            <option value="warning" selected>Warning - Potential issue to review</option>
                            <option value="error">Error - Critical validation failure</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="metric-description-input">Description:</label>
                        <textarea id="metric-description-input" placeholder="Describe what this metric validates and why it's important..." rows="3" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="metric-validation-logic">Validation Logic Template:</label>
                        <select id="metric-validation-logic">
                            <option value="basic">Basic Check - Simple validation pattern</option>
                            <option value="resource">Resource Check - Validate resource quantities/states</option>
                            <option value="timing">Timing Check - Validate task scheduling and timing</option>
                            <option value="dependency">Dependency Check - Validate task dependencies</option>
                            <option value="custom">Custom Logic - Write your own validation</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="metric-has-params"> 
                            This metric accepts custom parameters
                        </label>
                        <div id="metric-params-section" style="display: none; margin-top: 0.5rem;">
                            <textarea id="metric-params-input" placeholder='{"param1": "default_value", "param2": 42}' rows="2"></textarea>
                            <small>JSON object defining parameter names and default values</small>
                        </div>
                    </div>
                    
                    <!-- Auto-generated fields at bottom -->
                    <div class="form-row auto-generated-fields">
                        <div class="form-group">
                            <label for="metric-id-input">Metric ID:</label>
                            <input type="text" id="metric-id-input" placeholder="custom.validation.task_duration" readonly>
                            <small id="metric-id-status">Auto-generated based on category and name</small>
                        </div>
                        <div class="form-group">
                            <label for="metric-function-input">Function Name:</label>
                            <input type="text" id="metric-function-input" placeholder="validateTaskDuration" readonly>
                            <small id="metric-function-status">Auto-generated JavaScript function name</small>
                        </div>
                    </div>
                </form>
                
                <div class="dialog-buttons">
                    <button type="button" class="btn-secondary" id="metric-cancel-btn">Cancel</button>
                    <button type="button" class="btn-primary" id="metric-add-btn">Add Metric</button>
                </div>
            </div>
        </div>

        <!-- Context Menu -->
        <div id="context-menu" class="context-menu" style="display: none;">
            <div class="context-menu-item" id="context-menu-delete">
                Delete
            </div>
        </div>

        <!-- Drag Overlay for Resizing -->
        <div id="drag-overlay" class="drag-overlay"></div>

        <script src="/assets/js/context-menu.js"></script>
        <script src="/assets/js/html-sanitizer.js"></script>

        <!-- Playground modules in dependency order -->
        <script src="/assets/js/playground/playground-utils.js"></script>
        <script src="/assets/js/playground/playground-ui.js"></script>
        <script src="/assets/js/playground/playground-validation.js"></script>
        <script src="/assets/js/playground/playground-timeline.js"></script>
        <script src="/assets/js/playground/playground-timeline-extensions.js"></script>
        <script src="/assets/js/playground/playground-digital-space.js"></script>
        <script src="/assets/js/playground/playground-display-editor.js"></script>
        <script src="/assets/js/playground/playground-save-load.js"></script>
        <script src="/assets/js/playground/playground-metrics-editor.js"></script>
        <script src="/assets/js/playground/playground-objects.js"></script>
        <script src="/assets/js/playground/playground-features.js"></script>
        <script src="/assets/js/playground/playground-editor.js"></script>
        <script src="/assets/js/playground/playground-core.js"></script>
    </body>
</html>